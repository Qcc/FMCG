<!DOCTYPE html>
<!-- 员工目标管理 页面 -->
<html>
    <head>
        <meta charset="UTF-8">
        <title>首页-快销宝-深圳市沟通科技有限公司</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8" />
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="../lib/css/layui.css">
        <style>
        .layui-form-top .layui-select-title>input{
            height: 28px;
            width: 110px;
        }
  .radio-group .layui-anim{
    display: none;
    margin-right: 2px;
  }
  .radio-group .layui-form-radio{
    width: 32px;
    height: 30px;
    margin: 0;
    padding: 0;
    text-align: center;
    color: #fff;
    background-color: #009688;
    margin-right: -3px;
  }
  .radio-group .layui-form-radio:hover{
    filter:(opactity=70);
    opacity:0.7;
  }
  .radio-group .layui-form-radio:last-child {
    border-radius: 0 2px 2px 0;
  }
  .radio-group .layui-form-radio:first-child {
    border-radius: 2px 0 0 2px;
  }
  .radio-group .layui-form-radioed{
    background-color: #5FB878;
  }
  </style>
    </head> 
    <body style="overflow-y: scroll;">
        <div class="layui-tab layui-tab-brief" style="margin: 0px;" lay-filter="docDemoTabBrief">
            <ul class="layui-tab-title">
              <li class="layui-this">报表统计</li>
              <li>目标设定</li>
            </ul>
            <div class="layui-tab-content" style="padding: 0px;height: 100px;">
              <!-- 统计报表 -->
              <div class="layui-tab-item layui-show">
                <div class="layui-row" style="position: absolute;top: 5px;right: 5px;">
                  <div class="layui-inline">
                        <div class="layui-input-inline" style="margin-right: -5px;">
                          <input type="text" style="height: 30px;" name="number" placeholder="员工姓名" autocomplete="off" class="layui-input">
                        </div>
                        <div class="layui-btn-group">
                          <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i> </button>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" style="width:60px;padding: 6px 5px 4px 0px;">日期范围</label>
                            <div class="layui-input-inline">
                              <input type="text" class="layui-input" id="test3" placeholder="YY-MM-DD" style="height: 30px;">
                            </div>
                          </div>
                    </div>
                    <div class="layui-input-inline">
                    <form class="layui-form layui-form-top" action="">
                          <div class="radio-group">
                            <!-- <input type="radio" name="cycle" value="周" title="周" > -->
                            <input type="radio" name="cycle" value="月" title="月" checked="">
                            <input type="radio" name="cycle" value="季" title="季">
                            <input type="radio" name="cycle" value="年" title="年">
                          </div>
                        </form>
                      </div>
              </div>
                <table class="layui-table" lay-data="{even:true,url:'../../compontents/demodata/emplotarget.json', page:true, id:'idTest2'}" lay-filter="kaoqinzu">
                  <thead>
                    <tr>
                      <th lay-data="{type:'checkbox'}" rowspan="2"></th>
                      <th lay-data="{field:'empname', sort: true}" rowspan="2">姓名</th>
                      <th lay-data="{field:'dept'}" rowspan="2">部门</th>
                      <th lay-data="{align:'center'}" colspan="3">收款金额</th>
                    </tr>
                    <tr>
                      <th lay-data="{field:'targetreceipts'}">目标</th>
                      <th lay-data="{field:'actualreceipts',sort: true}">完成</th>
                      <th lay-data="{field:'completion',sort: true}">完成率</th>
                    </tr>

                  </thead>
                </table>
              </div>
              <!-- 目标设定 -->
              <div class="layui-tab-item">
                  <div class="layui-row" style="position: absolute;top: 5px;right: 5px;">
                  <div class="layui-input-inline">
                      <div class="layui-input-inline" style="margin-right: -5px;">
                        <input type="text" style="height: 30px;" name="number" placeholder="公司/姓名/电话" autocomplete="off" class="layui-input">
                      </div>
                      <div class="layui-btn-group">
                        <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i></button>
                      </div>
                      <div class="layui-btn-group">
                          <button class="layui-btn layui-btn-sm newtarget">新建</button>
                          <button class="layui-btn layui-btn-sm deltarget">删除</button>
                        </div>
                    </div>
                  </div>
                    <table class="layui-table" id="emptargetset" lay-filter="emptager"></table>
              </div>
              <!-- 添加目标表单 -->
              <div id="newemptarget" style="display:none;padding-right: 50px;">
                  <form class="layui-form" action="" lay-filter="targetform">
                      <div class="layui-form-item">
                        <label class="layui-form-label">选择</label>
                        <div class="layui-input-block">
                          <div class="layui-inline">
                            <input type="text" uidvalue="" required name="employee" lay-verify="required" autocomplete="off" placeholder="请选择员工/部门" class="layui-input emplist">
                          </div>
                          <div class="layui-inline">
                            <button class="layui-btn layui-btn-primary btnemployee" style="margin-left: -15px;" title="选择员工"><i class="layui-icon">&#xe612;</i></button>
                            <!-- 按部门提交 -->
                            <!-- <button class="layui-btn layui-btn-primary btndept" style="margin-left: -5px;" title="选择部门"><i class="layui-icon">&#xe613;</i></button> -->
                          </div>
                        </div>
                      </div>
                      
                      <div class="layui-form-item">
                        <label class="layui-form-label">考核区间</label>
                        <div class="layui-input-block">
                            <input class="layui-input" name="targettime"  type="text" id="targett">
                        </div>
                        <div class="layui-form-mid layui-word-aux" style="margin-left: 110px;">在此期间内考核目标会按周期循环</div>
                      </div>
                      <div class="layui-form-item layui-form-text">
                        <label class="layui-form-label">考核周期</label>
                        <div class="layui-input-block">
                            <select name="period" lay-verify="zhouqi">
                                <option value="3" selected>月</option>
                                <option value="2">季度</option>
                                <option value="1">年</option>
                              </select>
                        </div>
                      </div>

                      <div class="layui-form-item">
                          <label class="layui-form-label">考核指标</label>
                          <div class="layui-input-inline">
                              <input type="number" name="kpi" required lay-verify="required" placeholder="请输入收款金额" autocomplete="off" class="layui-input">
                          </div>
                        </div>

                      <div class="layui-form-item">
                        <div class="layui-input-block">
                          <button class="layui-btn" lay-submit lay-filter="ntarget">确认</button>
                          <button type="reset" class="layui-btn layui-btn-primary newrest">重置</button>
                        </div>
                      </div>
                    </form>
              </div>
              <!-- 修改目标表单 -->
              <div id="targetxg" style="display:none;padding-right: 50px;">
                  <form class="layui-form" action="" lay-filter="targetxg">
                      <div class="layui-form-item">
                        <label class="layui-form-label">员工</label>
                        <div class="layui-input-block">
                          <div class="layui-inline">
                            <input type="text" uidvalue="" disabled name="employee" lay-verify="required" autocomplete="off" placeholder="请选择员工/部门" class="layui-input emplist">
                          </div>
                        </div>
                      </div>
                      
                      <div class="layui-form-item" style="display: none">
                            <input type="text" name="uid" >
                      </div>

                      <div class="layui-form-item">
                        <label class="layui-form-label">考核区间</label>
                        <div class="layui-input-block">
                            <input class="layui-input" name="xgtarget"  type="text" id="xgtargett">
                        </div>
                        <div class="layui-form-mid layui-word-aux" style="margin-left: 110px;">在此期间内考核目标会按周期循环</div>
                      </div>
                      <div class="layui-form-item layui-form-text">
                        <label class="layui-form-label">考核周期</label>
                        <div class="layui-input-block">
                            <select name="period" lay-verify="zhouqi">
                                <option value="3" selected>月</option>
                                <option value="2">季度</option>
                                <option value="1">年</option>
                              </select>
                        </div>
                      </div>

                      <div class="layui-form-item">
                          <label class="layui-form-label">考核指标</label>
                          <div class="layui-input-inline">
                              <input type="number" name="kpi" required lay-verify="required" placeholder="请输入收款金额" autocomplete="off" class="layui-input">
                          </div>
                        </div>

                      <div class="layui-form-item">
                        <div class="layui-input-block">
                          <button class="layui-btn" lay-submit lay-filter="btnxg">保存</button>
                          <button type="reset" class="layui-btn layui-btn-primary btnxgrest">取消</button>
                        </div>
                      </div>
                    </form>
              </div>
              <div  id="employeese" style="display: none;">
                  <table class="layui-table" id="employeetb"></table>
                  <div style="position: relative;right: 20px;text-align: right;">
                    <button class="layui-btn  layui-btn-primary empcancel">取消</button>
                    <button  class="layui-btn empenter">确定</button>
                  </div>
              </div>
              <div  id="deptse" style="display: none;">
                  <table class="layui-table" id="depttb"></table>
                  <div style="position: relative;right: 20px;text-align: right;">
                    <button class="layui-btn  layui-btn-primary deptcancel">取消</button>
                    <button  class="layui-btn deptenter">确定</button>
                  </div>
              </div>
        </div>
    <script type="text/html" id="targettool">
      <a class="layui-btn layui-btn-xs" lay-event="edit">修改</i></a>
      <a class="layui-btn layui-btn-xs" lay-event="delete">删除</i></a>
    </script>  
    <script type="text/html" id="period">
      {{#  if(d.period === 1){ }}
        <span style="color: #01AAED;">年</span>
      {{#  } else if(d.period === 2){ }}
        <span style="color: #FFB800;">季度</span>
      {{# }else if(d.period === 3) { }}
      <span style="color: #FF5722;">月</span>
      {{#  } }}
    </script>                                       
    <script src="../lib/layui.js"></script>
    <!-- <script src="../js/attendance.js"></script> -->
    <!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
    <script>
    layui.config({
    base: '../compontents/' //静态资源所在路径
  }).extend({
    admin: 'admin' //主入口模块
  }).use(['element','form','table','layer','admin','laydate'], function(){
  var $ = layui.jquery
  ,element = layui.element
  ,laydate = layui.laydate
  ,form = layui.form
  ,setter = layui.setter
  ,admin = layui.admin
  ,layer = layui.layer
  ,table = layui.table;

  var userTable = table.render({
  elem: '#emptargetset',
  url: setter.layuiqueryapi,
  method:'post',
  where: 	{jsonparam: JSON.stringify([{
        solve_name_conflict: false,
    		model: 'crm_achievementtargets',
    		api: 'read',
	    	columns: ['count(uid) AS total'],
	    },{
    		model: 'crm_achievementtargets',
        api: 'read',
        columns:['*', 'employee$$org_employee.empname AS employeename'],
        association: {  	
          employee: {},
        },
        order: [ 
          {
           column: "uid",
           order: "DESC", //可选（默认为ASC）
          }
         ], 
	    }])},
  cols: [[
      {type:'checkbox'}
      ,{field:'employeename', title: '员工', sort: true}
      ,{field:'kpi', title: '考核目标', sort: true}
      ,{field:'period', title: '考核周期',templet: '#period'}
      ,{field:'startdate', title: '开始日期', sort: true}
      ,{field:'enddate', title: '结束日期'}
      ,{field:'', title: '操作',align:'center', toolbar: '#targettool'}
    ]],
  page: true,
  done: function(res, curr, count){
  }
  });

  //监听工具条
  table.on('tool(emptager)', function(obj){
    var data = obj.data;
    if(obj.event === 'edit'){
      console.log('edit ',obj);
      var xglayer =layer.open({
        type: 1,
        title:'修改指标',
        // skin: 'layui-layer-demo', //样式类名
        closeBtn: 1, //不显示关闭按钮
        anim: 2,
        area: ['500px', '400px'],
        shadeClose: true, //开启遮罩关闭
        offset: '20px',
        content: $('#targetxg')
      });
      laydate.render({
      elem: '#xgtargett'
      ,range: true
      ,value: obj.data.startdate + ' - '+obj.data.enddate
      });
      form.val("targetxg", {
        "employee":obj.data.employeename
        ,"period":obj.data.period
        ,"kpi":obj.data.kpi
        ,"uid":obj.data.uid
        })
      $('.btnxgrest').on('click',function(){
        layer.close(xglayer);
      })
      form.on('submit(btnxg)', function(data){
        var startdate=data.field.xgtarget.slice(0,10)
        ,enddate=data.field.xgtarget.slice(13,24);
        target={};
        target.employee = data.employee;      
        target.period = data.field.period;
        target.kpi = data.field.kpi;
        target.startdate = startdate;
        target.enddate = enddate;
        admin.req({
          url: setter.standardapi //实际使用请改成服务端真实接口
            ,data: {
              model:'crm_achievementtargets',
              api:'update',
              jsonparam: JSON.stringify({
                entity:target,
                condition: {
                  simple: {
                    item1: {
                      column: 'uid',
                      cop: '=',
                      value: data.field.uid
                    }
                  }
                }
              })
              }      
            ,success: function(res){
              if(res.errorCode === 0){
                layer.close(xglayer);
                //同步更新表格缓存
                target.period = parseInt(target.period);
                obj.update({
                  period:target.period,
                  kpi:target.kpi,
                  startdate:target.startdate,
                  enddate:target.enddate
                });
              }
          }
            ,error: function(res){
              //登入成功的提示与跳转
              layer.msg('修改失败', {
                offset: '15px'
                ,icon: 5
                ,time: 1000
              });
            }
          });
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
      });
    } else if(obj.event === 'delete'){
      layer.confirm('真的删除么', function(index){
        admin.req({
        url: setter.standardapi //实际使用请改成服务端真实接口
        ,data: {
          model:'crm_achievementtargets',
          api:'delete',
          jsonparam: JSON.stringify({
            condition: {
              simple: {
                item1: {
                  column: 'uid',
                  cop: '=',
                  value: obj.data.uid
                }
              }
            }
          })
        }  
        ,success: function(res){
          if(res.errorCode === 0){
            obj.del();
            // userTable.reload();
          }
        }
        ,error: function(res){
          layer.msg('删除失败', {
            offset: '15px'
            ,icon: 5
            ,time: 1000
          });
        }
      });
      layer.close(index);
      });
    }
  });
  
  

  $('.newtarget').on('click',function(){
    var newlayer =layer.open({
      type: 1,
      title:'新建指标',
      // skin: 'layui-layer-demo', //样式类名
      closeBtn: 1, //不显示关闭按钮
      anim: 2,
      area: ['500px', '400px'],
      shadeClose: true, //开启遮罩关闭
      offset: '20px',
      content: $('#newemptarget')
    });
    form.on('submit(ntarget)', function(data){
    var uidvalue = $('.emplist').attr('uidvalue')
    ,startdate=data.field.targettime.slice(0,10)
    ,enddate=data.field.targettime.slice(13,24)
    employee=uidvalue.split(',');
    target=[];
    for (let i = 0; i < employee.length; i++) {
      var emp = {};
      emp.employee = employee[i];      
      emp.period = data.field.period;
      emp.kpi = data.field.kpi;
      emp.startdate = startdate;
      emp.enddate = enddate;
      emp.model = 'crm_achievementtargets';
      emp.api = 'create';
      target.push(emp);
    }
    admin.req({
      url: layui.setter.batchapi //实际使用请改成服务端真实接口
        ,data: {
           jsonparam: JSON.stringify(target)
          }      
        ,success: function(res){
          if(res.errorCode === 0){
            layer.msg('创建成功', {
              offset: '15px'
              ,icon: 1
              ,time: 1000
            });
          }
          layer.close(newlayer);
          userTable.reload();
      }
        ,error: function(res){
          //登入成功的提示与跳转
          layer.msg('创建失败', {
            offset: '15px'
            ,icon: 5
            ,time: 1000
          });
        }
      });
        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
    });
  })

  $('.btnemployee').on('click',function(e){
    var emplayer = layer.open({
      type: 1,
      title:'选择职员',
      // skin: 'layui-layer-demo', //样式类名
      closeBtn: 1, //不显示关闭按钮
      anim: 2,
      area: ['500px', '480px'],
      shadeClose: true, //开启遮罩关闭
      offset: '20px',
      maxmin:1,
      content: $('#employeese')
    });
    var empTable = table.render({
      elem: '#employeetb',
      url: setter.layuiqueryapi,
      method:'post',
      height:357,
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'org_employee',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'org_employee',
            api: 'read',
            columns:['*', 'dept$$org_department.deptname AS deptname'],
            association: {  	
              dept: {},
            }
	        }])},
          cols: [[
            {type:'checkbox'}
            ,{field:'empname', title: '姓名'}
            ,{field:'deptname', title: '部门', sort: true}
            ]],
          page: true,
          done: function(res, curr, count){
          
          }
          });
    e.preventDefault();
    $('.empenter').on('click',function(){
      var checkStatus = table.checkStatus('employeetb')
      ,data = checkStatus.data
      ,uid=[]
      ,name=[]; 
      for (let i = 0; i < data.length; i++) {
        name.push(data[i].empname);
        uid.push(data[i].uid);
      }
      $('.emplist').val(name.join()).attr('uidvalue',uid.join());
      layer.close(emplayer);
    })
    $('.empcancel').on('click',function(){
      layer.close(emplayer);
    })
    return false;
  });

  $('.btndept').on('click',function(e){
    var deptlayer = layer.open({
      type: 1,
      title:'选择部门',
      // skin: 'layui-layer-demo', //样式类名
      closeBtn: 1, //不显示关闭按钮
      anim: 2,
      area: ['500px', '480px'],
      shadeClose: true, //开启遮罩关闭
      offset: '20px',
      maxmin:1,
      content: $('#deptse')
    });
    var empTable = table.render({
      elem: '#depttb',
      url: setter.layuiqueryapi,
      method:'post',
      height:357,
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'org_department',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'org_department',
            api: 'read'
	        }])},
          cols: [[
            {type:'checkbox'}
            ,{field:'deptname', title: '部门', sort: true}
            ,{field:'deptshortnumber', title: '编号'}
            ]],
          page: true,
          done: function(res, curr, count){
          
          }
          });
    e.preventDefault();
    $('.deptenter').on('click',function(){
      var checkStatus = table.checkStatus('depttb')
      ,data = checkStatus.data;
      layer.alert(JSON.stringify(data));
    })
    $('.deptcancel').on('click',function(){
      layer.close(deptlayer)  
    })
    return false;
  });
      
      laydate.render({
      elem: '#test3'
      ,offset: 't'
      ,range: true
      ,value: '2018-07-01 - 2018-07-31'
    });
    laydate.render({
      elem: '#targett'
      ,range: true
      ,value: admin.getNowDay()+' - '+admin.getYearEndDay()
    });
      //添加考勤组
      $('.add-attapproval').on('click',function(){
        addTab(window.parent.layui.element,'新建考勤组','add-app','pages/attsettingsadd.html')
      })
      //修改考勤组
      table.on('tool(kaoqinzu)', function(obj){
        console.log('1');
        var data = obj.data;
        // 循环 tab页面如果已经打开，则切换到对应页面
        if(obj.event === 'edit'){
          addTab(window.parent.layui.element,'修改考勤组','edit-app','pages/attsettingsedit.html')
        }
        return false;
      });
      //修改请假类型
      table.on('tool(ygmubiao)', function(obj){
        console.log('2');
      var data = obj.data;
      if(obj.event === 'edit'){
        layer.msg('ID：'+ data + ' 编辑');
      } else if(obj.event === 'delete'){
        layer.confirm('真的删除行么', function(index){
          obj.del();
          layer.close(index);
        });
      }
      return false;
      });
      
      //已发任务查看执行详情
  table.on('tool(demoEvent)', function(obj){
    var data = obj.data;
    if(obj.event === 'setSign'){
      layer.prompt({
        formType: 2
        ,title: '修改 ID 为 ['+ data.id +'] 的用户签名'
        ,value: data.sign
      }, function(value, index){
        layer.close(index);
        
        //这里一般是发送修改的Ajax请求
        
        //同步更新表格和缓存对应的值
        obj.update({
          sign: value
        });
      });
    }
  });

  //监听展开操作
  form.on('switch(sexDemo)', function(obj){
    layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);
  });

  //iframe中添加首页tab页面
      function addTab(tab,title,id,url){
        for (var i = 0; i < window.parent.layui.$('.kt-iframe').length; i++) {
            if(window.parent.layui.$('.kt-iframe').eq(i).attr('tab-id') == id){
                tab.tabChange('kt_toptab',id);
                event.stopPropagation();
                return;
            }
        };
        tab.tabAdd('kt_toptab', {
          title: title
          ,content: '<iframe  tab-id="' + id + '" id=iframe' + id + ' " frameborder="0" src="' + url + '" scrolling="yes" class="kt-iframe"></iframe>'
          ,id: id
        });
        tab.tabChange('kt_toptab', id);
      }
    });
    </script>  
    </body>
</html>