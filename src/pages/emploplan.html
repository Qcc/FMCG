<!DOCTYPE html>
<!-- 员工计划任务 页面 -->
<html>
    <head>
        <meta charset="UTF-8">
        <title>首页-快销宝-深圳市沟通科技有限公司</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8" />
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="../lib/css/layui.css">
        <style>
            .plan-waper{
              text-align: center;
              line-height: 30px;
              margin: 10px 60px;
            }
            .plan-title{
              font-size: 20px;
              font-weight: 400;
            }
            .plan-author{
              margin: 0 10px;
            }
            .create-time, .plan-author{
              text-align: right;
              margin-right: 60px;
            }
            .plan-date{
              margin: 0 20px;
            }
            .plan-content{
              text-align: left;
             margin: 20px 0px;
             text-indent:30px;
            }
          </style>
    </head>
<body style="overflow-y: scroll;">
        <div class="layui-tab layui-tab-brief" style="margin: 0px;" lay-filter="task">
            <ul class="layui-tab-title">
              <li class="layui-this">收到任务</li>
              <li>已发任务</li>
              <li>任务看板</li>
              <!-- <li>办理结果设置</li> -->
            </ul>
            <div class="layui-tab-content" style="height: 100px;">
              <!-- 收到的任务 -->
              <div class="layui-tab-item layui-show">
                <div class="layui-row" style="text-align: right;text-align: right;position: absolute;top: 5px;right: 5px;">
                  <div class="layui-inline">
                      <div class="layui-input-inline">
                        <div class="layui-inline">
                          <label class="layui-form-label" style="width:60px;padding: 6px 5px 4px 0px;">日期范围</label>
                          <div class="layui-input-inline">
                            <input type="text" class="layui-input" id="test3" placeholder="YY-MM-DD" style="height: 30px;">
                          </div>
                        </div>
                        <div class="layui-input-inline" style="margin-right: -5px;">
                          <input type="text" style="height: 30px;" name="number" placeholder="搜索任务名称" autocomplete="off" class="layui-input">
                        </div>
                        <div class="layui-btn-group">
                          <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i> </button>
                        </div>
                      </div>
                    </div>
                <!-- <div class="layui-btn-group">
                  <button class="layui-btn layui-btn-sm add-attapproval">新建</button>
                </div> -->
              </div>
              <!-- 收到的任务 -->
              <table class="layui-table" id="sdplan" lay-filter="sdplantb"></table>
              </div>
              <!-- 已发任务 -->
              <div class="layui-tab-item">
                  <div class="layui-row" style="text-align: right;text-align: right;position: absolute;top: 5px;right: 5px;">
                  <div class="layui-input-inline">
                      <div class="layui-inline">
                        <label class="layui-form-label" style="padding: 6px 5px 4px 0px;">日期范围</label>
                        <div class="layui-input-inline">
                          <input type="text" class="layui-input" id="test3" placeholder="YY-MM-DD" style="height: 30px;">
                        </div>
                      </div>
                      <div class="layui-input-inline" style="margin-right: -5px;">
                        <input type="text" style="height: 30px;" name="number" placeholder="搜索任务名称" autocomplete="off" class="layui-input">
                      </div>
                      <div class="layui-btn-group">
                        <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i></button>
                      </div>
                      <div class="layui-btn-group">
                          <button class="layui-btn layui-btn-sm btnaddplan">新建</button>
                        </div>
                    </div>
                  </div>
                  <!-- 已发送的任务 -->
                  <table class="layui-table" id="sendplan" lay-filter="sendplan"></table>
                  <!-- 已发送的任务详情 -->
                  <table class="layui-table" id="sddetils" lay-filter="sddetils"></table>
              </div>
              <!-- 任务看板 -->
              <div class="layui-tab-item">
                  <div class="layui-row" style="text-align: right;text-align: right;position: absolute;top: 5px;right: 5px;">
                      <div class="layui-input-inline">
                          <div class="layui-inline">
                            <label class="layui-form-label" style="padding: 6px 5px 4px 0px;">日期范围</label>
                            <div class="layui-input-inline">
                              <input type="text" class="layui-input" id="test3" placeholder="YY-MM-DD" style="height: 30px;">
                            </div>
                          </div>
                          <div class="layui-input-inline" style="margin-right: -5px;">
                            <input type="text" style="height: 30px;" name="number" placeholder="搜索任务名称" autocomplete="off" class="layui-input">
                          </div>
                          <div class="layui-btn-group">
                            <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i></button>
                          </div>
                        </div>
                      </div>
                      <!-- 任务看板 -->
                        <table class="layui-table" id="taskview" lay-filter="kbplan"></table>
                        <!-- 任务执行情况详情 -->
                        <table class="layui-table" id="kbdetils" lay-filter="kbdetils"></table>
              </div>
            </div>
            <!-- 新建计划任务 -->
            <div id="newplan" style="display: none">
                <form class="layui-form" action="" lay-filter="planform" style="margin-right: 40px;">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">执行人</label>
                            <div class="layui-input-inline">
                              <input type="text" lay-verify="required" autocomplete="off" placeholder="请选择员工/部门" class="layui-input namelist">
                            </div>
                            <div class="layui-input-inline">
                              <input type="text" name="planretexectors" class="uidlist" style="display: none">
                            </div>
                            <div class="layui-input-inline" style="width: 70px">
                              <button class="layui-btn layui-btn-primary btnaddemp" style="margin-left: -10px;" title="选择执行人"><i class="layui-icon">&#xe612;</i></button>
                            </div>
                        </div>
                        <div class="layui-input-inline" style="position: absolute;right: 20px;">
                            <button class="layui-btn" lay-submit lay-filter="nplan">新建</button>
                            <button type="reset" class="layui-btn layui-btn-primary planrest">取消</button>
                        </div>
                      </div>
                  
                  
                  <div class="layui-form-item">
                    <label class="layui-form-label">拜访客户</label>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                          <input type="text" lay-verify="required" autocomplete="off" placeholder="请选择客户" class="layui-input cusnamelist">
                        </div>
                        <div class="layui-input-inline">
                          <input type="text" name="plancustomer" class="cuslist" style="display: none">
                        </div>
                        <div class="layui-input-inline" style="width: 70px">
                          <button class="layui-btn layui-btn-primary btnaddcus" style="margin-left: -10px;" title="选择客户"><i class="layui-icon">&#xe613;</i></button>
                        </div>
                    </div>
                  </div>

                  <div class="layui-form-item">
                    <label class="layui-form-label">开始时间</label>
                    <div class="layui-input-inline">
                      <input class="layui-input" lay-verify="required" autocomplete="off" name="planstartdate" type="text" id="plandate">
                    </div>
                  </div>
                  
                  <div class="layui-form-item">
                    <label class="layui-form-label">结束时间</label>
                    <div class="layui-input-inline">
                      <input class="layui-input" lay-verify="required" autocomplete="off" name="planenddate" type="text" id="plantime">
                    </div>
                  </div>
                  
                  <div class="layui-form-item">
                    <label class="layui-form-label">标题</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="plantitle" lay-verify="required" autocomplete="off" placeholder="请输入计划标题" type="text" id="xgtargett">
                    </div>
                  </div>
                 
                  <div class="layui-form-item">
                    <label class="layui-form-label">计划内容</label>
                    <div class="layui-input-block">
                        <textarea name="plancontent" lay-verify="required" autocomplete="off" placeholder="请输入计划说明" class="layui-textarea"></textarea>
                    </div>
                  </div>
                 
                  <div class="layui-form-item">
                    <div class="layui-inline">
                      <label class="layui-form-label">是否提醒</label>
                      <div class="layui-input-inline" style="width: auto">
                        <input type="checkbox" name="planifreminder" title="提醒" value="1" lay-skin="primary" checked>
                      </div>
                    </div>
                    <div class="layui-inline">
                      <label class="layui-form-label" style="padding-left: 0px;width: 100px;">提前提醒(小时)</label>
                      <div class="layui-input-inline">
                        <input class="layui-input" name="planremindertime" value="1" placeholder="小时" type="number" id="xgtargett" style="width: 60px;">
                      </div>
                    </div>
                  </div>
                  
                  <div class="layui-form-item">
                  </div>
                  </form>
              </div>
              <!-- 选择员工表 -->
              <div  id="planemployee" style="display: none;">
                  <table class="layui-table" id="employeetb"></table>
                  <div style="position: relative;right: 20px;text-align: right;">
                    <button class="layui-btn  layui-btn-primary empcancel">取消</button>
                    <button  class="layui-btn empenter">确定</button>
                  </div>
              </div>
              <!-- 选择客户表 -->
              <div  id="plancus" style="display: none;">
                  <table class="layui-table" id="custb" lay-filter="custb"></table>
                  <div style="position: relative;right: 20px;text-align: right;">
                    <button class="layui-btn  layui-btn-primary cuscancel">取消</button>
                    <button  class="layui-btn cusenter">确定</button>
                  </div>
              </div>
              <!-- 查看任务 -->
              <div  id="viewplan" style="display: none;">
                  <div class="layui-row plan-waper">
                      <div class="plan-title">
                        <span class="kttitle"></span>
                      </div>
                      <div class="layui-inline">
                          <span>拜访客户:</span>
                          <span class="ktcus"></span>
                        </div>
                      <div class="plan-date  layui-inline">
                        <span>要求完成时间:</span>
                        <span class="ktstime"></span>
                      </div>
                      <hr/>
                      <div class="plan-content">
                        <span class="ktcontent"></span>
                      </div>
                      <div class="create-time">
                        <span>发布时间：</span>
                        <span class="ktctime"></span>
                      </div>
                      <div class="plan-author">
                        <span>定制人:</span>
                        <span class="ktcreator"></span>
                      </div>
                    </div>
                  </div>
        </div>
    <script type="text/html" id="plan">
      <a class="layui-btn layui-btn-xs" lay-event="view">查看</i></a>
    </script>                 
    <script type="text/html" id="view">
      <a class="layui-btn layui-btn-xs" lay-event="view">执行情况</i></a>
    </script>                 
    <script type="text/html" id="type">
      <a class="layui-btn layui-btn-xs" lay-event="edit">修改</i></a>
      <a class="layui-btn layui-btn-xs" lay-event="delete">删除</i></a>
    </script>   
    <script type="text/html" id="plandetils">
      <a class="layui-btn layui-btn-xs" lay-event="edit">重办</i></a>
      <a class="layui-btn layui-btn-xs" lay-event="delete">点评</i></a>
    </script>  
  
    <script type="text/html" id="starttime">
      {{#  if(d.planretstarttime){ }}
      {{# var t = new Date(d.planretstarttime).toLocaleString(); }}
      <span >{{ t }}</span>
      {{#  } else{ }}
      <span style="color: #FFB800;">未执行</span>
      {{#  } }}
    </script> 

    <script type="text/html" id="endtime">
      {{#  if(d.planretendtime){ }}
      {{# var t = new Date(d.planretendtime).toLocaleString(); }}
      <span >{{ t }}</span>
      {{#  } else{ }}
      <span style="color: #FFB800;">未执行</span>
      {{#  } }}
    </script>

    <script type="text/html" id="state">
      {{#  if(d.planretstate === 0){ }}
        <span style="color: #FFB800;">未执行</span>
      {{#  } else if(d.planretstate === 1){ }}
        <span style="color: #5FB878;">执行中</span>
      {{#  } else if(d.planretstate === 2){ }}
        <span style="color: #c2c2c2;">已经执</span>
      {{#  } else { }}
        <span>{{ parseInt(time/86400000) }}天前</span>
      {{#  } }}
    </script>    
    
    <script type="text/html" id="img">
      {{#  if(d.picpath){ }}
      {{# var path = layui.admin.base64decode(d.picpath);path = layui.setter.root + path;}}
        <img src= {{path}}></span>
      {{#  } else { }}
        <span>无</span>
      {{#  } }}
    </script>    
    
    <script type="text/html" id="createtime">
      {{#  var now = new Date().getTime();var time = now - d.plancreatetime;}}
      {{#  if(time < 60000){ }}
        <span>{{ parseInt(time/1000) }}秒前</span>
      {{#  } else if(time < 3600000){ }}
        <span>{{ parseInt(time/60000) }}分钟前</span>
      {{#  } else if(time < 86400000){ }}
        <span>{{ parseInt(time/3600000) }}小时前</span>
      {{#  } else { }}
        <span>{{ parseInt(time/86400000) }}天前</span>
      {{#  } }}
    </script>          
    <script src="../lib/layui.js"></script>
    <!-- <script src="../js/attendance.js"></script> -->
    <!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
    <script>
     layui.config({
    base: '../compontents/' //静态资源所在路径
  }).extend({
    admin: 'admin' //主入口模块
  }).use(['element','form','table','layer','admin','laydate'], function(){
  var $ = layui.jquery
  ,element = layui.element
  ,laydate = layui.laydate
  ,form = layui.form
  ,setter = layui.setter
  ,admin = layui.admin
  ,layer = layui.layer
  ,table = layui.table
  ,iam = JSON.parse(layui.sessionData(setter.tableName).iam)[0].uid//当前登录员工UID
  ,sPlantb = false
  ,allTb = false;
  // 收到的任务
  var userTable = table.render({
  elem: '#sdplan',
  url: setter.layuiqueryapi,
  method:'post',
  where:{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'oa_plantask_result',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'oa_plantask_result',
            api: 'read',
            columns:['*', 'plan$$oa_plantask.plancontent AS plancontent',
              'plan$$oa_plantask.plancreatetime AS plancreatetime',
              'plan__plancreator$$org_employee.empname AS plancreator',
              'plan$$oa_plantask.plantitle AS plantitle',
              'plan$$oa_plantask.planstartdate AS planstartdate',
              'plan$$oa_plantask.planenddate  AS planenddate',
              'plan__plancustomer$$crm_customer.custmname AS plancustomer'],
            association: {  	
              plan: {
                planstartdate:{},
                planenddate:{},
                association: {
                  plancreator:{},
                  plancustomer: {},
                }
              },
              planretappendixlist:{}
            },
            order: [ 
             {
              column: "uid",
              order: "DESC", //可选（默认为ASC）
             }
            ],
            condition:{"simple":{"item1":{"column":"planretexector","cop":"=","value":iam}}}
          }])
        },
  cols: [[
      {field:'plancreatetime', title: '创建时间', sort: true,templet: '#createtime'}
      ,{field:'plancreator', title: '创建人'}
      ,{field:'plancustomer', title: '拜访客户'}
      ,{field:'plantitle', title: '计划标题', sort: true}
      ,{field:'plancontent', title: '内容'}
      ,{field:'planappendixlist', title: '附件'}
      ,{field:'', title: '操作',align:'center', toolbar: '#plan'}
    ]],
  page: true,
  done: function(res, curr, count){
  }
  });
  // 查看任务
  table.on('tool(sdplantb)', function(obj){
    var data = obj.data;
    if(obj.event === 'view'){
      var planlayer = layer.open({
      type: 1,
      title:'查看拜访任务',
      // skin: 'layui-layer-demo', //样式类名
      closeBtn: 1, //不显示关闭按钮
      anim: 2,
      area: ['500px', '480px'],
      shadeClose: false, //开启遮罩关闭
      offset: '20px',
      maxmin:1,
      content: $('#viewplan'),
      success: function(layero, index){
        $(".kttitle").text(data.plantitle);
        $(".ktcus").text(data.plancustomer);
        $(".ktcreator").text(data.plancreator);
        $(".ktstime").text(data.planstartdate+' ~ '+data.planenddate);
        $(".ktcontent").text(data.plancontent);
        $(".ktctime").text(new Date(data.plancreatetime).toLocaleString());
      }
    });
    layer.full(planlayer);
    }
  });

  // 切换tab页面
  element.on('tab(task)', function(data){
    if(data.index === 1 ){
      if(sPlantb){
        return;
      }
      // 已发送的任务
      var splan = table.render({
      elem: '#sendplan',
      height: ($(document).height() - 40)/2,
      url: setter.layuiqueryapi,
      method:'post',
      where:{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'oa_plantask',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'oa_plantask',
            api: 'read',
            columns:["oa_plantask.*","plancreator$$org_employee.empname AS creatorname",
            'plancustomer$$crm_customer.custmname AS customer'],
            association: {  	
              plancustomer: {},
              plancreator:{}
            },
            order: [ 
             {
              column: "uid",
              order: "DESC", //可选（默认为ASC）
             }
            ],
            condition:{"simple":{"item1":{"column":"plancreator","cop":"=","value":iam}}}
          }])
        },
      cols: [[
          {type:'checkbox'}
          ,{field:'plancreatetime', title: '创建时间', sort: true,templet: '#createtime'}
          ,{field:'customer', title: '拜访客户'}
          ,{field:'planstartdate', title: '开始时间'}
          ,{field:'planenddate', title: '结束时间'}
          ,{field:'plantitle', title: '计划标题', sort: true}
          ,{field:'plancontent', title: '内容'}
          ,{field:'weibanli', title: '操作',toolbar: '#view'}
        ]],
      page: true,
      done: function(res, curr, count){
        sPlantb = true;
      }
      });
            //添加计划任务
      $('.btnaddplan').on('click',function(){
        var newlayer =layer.open({
          type: 1,
          title:'新建拜访计划任务',
          // skin: 'layui-layer-demo', //样式类名
          closeBtn: 1, //不显示关闭按钮
          maxmin:true,
          anim: 2,
          area: ['500px', '400px'],
          shadeClose: false, //开启遮罩关闭
          offset: '20px',
          content: $('#newplan')
        });
        layer.full(newlayer);
        laydate.render({
          elem: '#plandate'
          // ,type:'datetime'
        });
        laydate.render({
          elem: '#plantime'
          // ,type:'datetime'
        });
        $('.planrest').on('click',function(){
          layer.close(newlayer);
        })
        form.on('submit(nplan)', function(data){
        data.field.planretexectors = data.field.planretexectors.split(',').map(Number); 
        admin.req({
          url: setter.standardapi
            ,data: {
               model: 'oa_plantask',
               api: 'create',
               jsonparam: JSON.stringify(data.field)
              }      
            ,success: function(res){
              if(res.errorCode === 0){
                layer.msg('创建成功', {
                  offset: '15px'
                  ,icon: 1
                  ,time: 1000
                });
              }
              layer.close(newlayer);
              splan.reload();
          }
            ,error: function(res){
              //登入成功的提示与跳转
              layer.msg('创建失败', {
                offset: '15px'
                ,icon: 5
                ,time: 1000
              });
            }
          });
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
      });
    }else if(data.index === 2){
      console.log(data);
      if(allTb){
        return;
      }
      // 任务看板
      var plandetil = table.render({
      elem: '#taskview',
      height: ($(document).height() - 40)/2,
      url: setter.layuiqueryapi,
      method:'post',
      where:{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'oa_plantask',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'oa_plantask',
            api: 'read',
            columns:["oa_plantask.*","plancreator$$org_employee.empname AS creatorname",
            'plancustomer$$crm_customer.custmname AS customer'],
            association: {
              plancustomer: {},
              plancreator:{}
            },
            order: [ 
             {
              column: "uid",
              order: "DESC", //可选（默认为ASC）
             }
            ],
            // condition:{"simple":{"item1":{"column":"plancreator","cop":"=","value":iam}}}
          }])
        },
      cols: [[
          {type:'checkbox'}
          ,{field:'creatorname', title: '创建人'}
          ,{field:'plancreatetime', title: '创建时间', sort: true,templet: '#createtime'}
          ,{field:'customer', title: '拜访客户'}
          ,{field:'planstartdate', title: '开始时间'}
          ,{field:'planenddate', title: '结束时间'}
          ,{field:'plantitle', title: '计划标题', sort: true}
          ,{field:'plancontent', title: '内容'}
          ,{field:'weibanli', title: '操作',toolbar: '#view'}
        ]],
      page: true,
      done: function(res, curr, count){
        allTb = true;
      }

      });
    }
  });

  // 显示任务看板执行详细情况  
  table.on('tool(kbplan)', function(obj){
    var data = obj.data;
    if(obj.event === 'view'){
      admin.req({
        url: setter.standardapi
        ,data: {
           model: 'oa_plantask_result',
           api: 'read',
           jsonparam: JSON.stringify({
            columns:["oa_plantask_result.*","planretexector$$org_employee.empname AS excname",
            'planretappendixlist$$bas_resource.resourcepath AS picpath'],
            association: { 
              planretexector: {},
              planretappendixlist:{
                association_column:"resourcegroupnumber",
				        association_model:"bas_resource"
              }
            },
            condition:{"simple":{"item1":{"column":"plan","cop":"=","value":data.uid}}}
           })
          }      
        ,success: function(res){
          if(res.errorCode === 0){
            var sdview = table.render({
              elem: '#kbdetils',
              data:res.entity,
              cols: [[
                  {type:'checkbox'}
                  ,{field:'excname', title: '执行人', sort: true}
                  ,{field:'planretstate', title: '状态', sort: true,templet:'#state'}
                  ,{field:'planretstarttime', title: '开始时间',templet: '#starttime'}
                  ,{field:'planretendtime', title: '结束时间',templet: '#endtime'}
                  ,{field:'planretdescription', title: '结果说明'}
                  ,{field:'picpath', title: '附件',templet: '#img'}
                ]],
              done: function(res, curr, count){
              }
            })
          }
        }
        ,error: function(res){
         
        }
      });
    }
  });
      // 显示已发送任务执行详细情况  
      table.on('tool(sendplan)', function(obj){
    var data = obj.data;
    if(obj.event === 'view'){
      admin.req({
        url: setter.standardapi
        ,data: {
           model: 'oa_plantask_result',
           api: 'read',
           jsonparam: JSON.stringify({
            columns:["oa_plantask_result.*","planretexector$$org_employee.empname AS excname",
            'planretappendixlist$$bas_resource.resourcepath AS picpath'],
            association: { 
              planretexector: {},
              planretappendixlist:{
                association_column:"resourcegroupnumber",
				        association_model:"bas_resource"
              }
            },
            condition:{"simple":{"item1":{"column":"plan","cop":"=","value":data.uid}}}
           })
          }      
        ,success: function(res){
          if(res.errorCode === 0){
            var sdview = table.render({
              elem: '#sddetils',
              data:res.entity,
              cols: [[
                  {type:'checkbox'}
                  ,{field:'excname', title: '执行人', sort: true}
                  ,{field:'planretstate', title: '状态', sort: true,templet:'#state'}
                  ,{field:'planretstarttime', title: '开始时间',templet: '#starttime'}
                  ,{field:'planretendtime', title: '结束时间',templet: '#endtime'}
                  ,{field:'planretdescription', title: '结果说明'}
                  ,{field:'picpath', title: '附件',templet: '#img'}
                ]],
              done: function(res, curr, count){
              }
            })
          }
        }
        ,error: function(res){
         
        }
      });
    }
  });

  
// 添加计划选择员工
$('.btnaddemp').on('click',function(e){
    var emplayer = layer.open({
      type: 1,
      title:'选择职员',
      // skin: 'layui-layer-demo', //样式类名
      closeBtn: 1, //不显示关闭按钮
      anim: 2,
      area: ['500px', '480px'],
      shadeClose: true, //开启遮罩关闭
      offset: '20px',
      maxmin:1,
      content: $('#planemployee')
    });
    var empTable = table.render({
      elem: '#employeetb',
      url: setter.layuiqueryapi,
      method:'post',
      height:357,
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'org_employee',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'org_employee',
            api: 'read',
            columns:['*', 'dept$$org_department.deptname AS deptname'],
            association: {  	
              dept: {},
            }
	        }])},
          cols: [[
            {type:'checkbox'}
            ,{field:'empname', title: '姓名'}
            ,{field:'deptname', title: '部门', sort: true}
            ]],
          page: true,
          done: function(res, curr, count){
          
          }
          });
    e.preventDefault();
    $('.empenter').on('click',function(){
      var checkStatus = table.checkStatus('employeetb')
      ,data = checkStatus.data
      ,uid=[]
      ,name=[]; 
      for (let i = 0; i < data.length; i++) {
        name.push(data[i].empname);
        uid.push(data[i].uid);
      }
      $('.namelist').val(name.join())
      $('.uidlist').val(uid.join())
      layer.close(emplayer);
    })
    $('.empcancel').on('click',function(){
      layer.close(emplayer);
    })
    return false;
  });
// 添加计划选择客户
$('.btnaddcus').on('click',function(e){
    var cuslayer = layer.open({
      type: 1,
      title:'选择客户',
      // skin: 'layui-layer-demo', //样式类名
      closeBtn: 1, //不显示关闭按钮
      anim: 2,
      area: ['500px', '480px'],
      shadeClose: true, //开启遮罩关闭
      offset: '20px',
      maxmin:1,
      content: $('#plancus')
    });
    var empTable = table.render({
      elem: '#custb',
      url: setter.layuiqueryapi,
      method:'post',
      height:357,
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'crm_customer',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'crm_customer',
            api: 'read'
	        }])},
          cols: [[
            {type:'checkbox'}
            ,{field:'custmname', title: '公司名称'}
            ,{field:'custmcontact', title: '联系人', sort: true}
            ]],
          page: true,
          done: function(res, curr, count){
          
          }
    });
    e.preventDefault();
    $('.cusenter').on('click',function(){
      var checkStatus = table.checkStatus('custb')
      ,data = checkStatus.data
      ,uid=[]
      ,name=[];
      if(data.length > 1){
        layer.msg('只能选择一家客户');
        return;
      } 
      console.log(data);
      for (let i = 0; i < data.length; i++) {
        name.push(data[i].custmname);
        uid.push(data[i].uid);
      }
      $('.cusnamelist').val(name.join())
      $('.cuslist').val(uid.join())
      layer.close(cuslayer);
    })
    $('.cuscancel').on('click',function(){
      layer.close(cuslayer);
    })
    return false;
  });

  laydate.render({
  elem: '#test3'
  ,range: true
  ,value: '2018-07-01 - 2018-07-31'
  });



    
      // //修改考勤组
      // table.on('tool(kaoqinzu)', function(obj){
      //   console.log('1');
      //   var data = obj.data;
      //   // 循环 tab页面如果已经打开，则切换到对应页面
      //   if(obj.event === 'edit'){
      //     addTab(window.parent.layui.element,'修改考勤组','edit-app','pages/attsettingsedit.html')
      //   }
      //   return false;
      // });
      // //修改请假类型
      // table.on('tool(jiaqi)', function(obj){
      //   console.log('2');
      // var data = obj.data;
      // if(obj.event === 'edit'){
      //   layer.msg('ID：'+ data + ' 编辑');
      // } else if(obj.event === 'delete'){
      //   layer.confirm('真的删除行么', function(index){
      //     obj.del();
      //     layer.close(index);
      //   });
      // }
      // return false;
      // });
      
      //已发任务查看执行详情
  // table.on('tool(demoEvent)', function(obj){
  //   var data = obj.data;
  //   if(obj.event === 'setSign'){
  //     layer.prompt({
  //       formType: 2
  //       ,title: '修改 ID 为 ['+ data.id +'] 的用户签名'
  //       ,value: data.sign
  //     }, function(value, index){
  //       layer.close(index);
        
  //       //这里一般是发送修改的Ajax请求
        
  //       //同步更新表格和缓存对应的值
  //       obj.update({
  //         sign: value
  //       });
  //     });
  //   }
  // });

  // //监听展开操作
  // form.on('switch(sexDemo)', function(obj){
  //   layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);
  // });

  // //iframe中添加首页tab页面
  //     function addTab(tab,title,id,url){
  //       for (var i = 0; i < window.parent.layui.$('.kt-iframe').length; i++) {
  //           if(window.parent.layui.$('.kt-iframe').eq(i).attr('tab-id') == id){
  //               tab.tabChange('kt_toptab',id);
  //               event.stopPropagation();
  //               return;
  //           }
  //       };
  //       tab.tabAdd('kt_toptab', {
  //         title: title
  //         ,content: '<iframe  tab-id="' + id + '" id=iframe' + id + ' " frameborder="0" src="' + url + '" scrolling="yes" class="kt-iframe"></iframe>'
  //         ,id: id
  //       });
  //       tab.tabChange('kt_toptab', id);
  //     }
    });
    </script>  
    </body>
</html>