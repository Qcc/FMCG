<!DOCTYPE html>
<!-- 商品管理 页面 -->
<html>
    <head>
        <meta charset="UTF-8">
        <title>商品管理-快销宝-深圳市沟通科技有限公司</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8" />
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="../lib/css/layui.css">
        <link rel="stylesheet" href="../css/goods.min.css">
        <style>
          .picview>a{
            position: relative;  
          }
          .picview>a>i{
            position: relative;  
            position: absolute;
            right: 13px;
          }
          .picview>a>i:hover{
            font-size: 20px;
            color: #FF5722;
          }
          .picview>a:hover i{
            display: inline;
          }
        .layui-upload-img{width: 92px;height: 92px;margin: 0 10px 10px 0;}
        </style>
    </head>
    <body style="overflow-y: scroll;">
        <div class="layui-tab layui-tab-brief" lay-filter="task" style="margin: 0px;">
          <ul class="layui-tab-title">
            <li class="layui-this">全部商品</li>
          </ul>
          <div class="layui-tab-content" style="padding: 0px;">
            <div class="layui-tab-item layui-show">
                <div class="layui-row" style="position: absolute;top: 5px;right: 5px;">
                  <div class="layui-inline">
                    <form class="layui-form" action="">
                      <div class="layui-input-inline">
                          <div class="layui-input-inline">
                              <div class="layui-input-inline" style="margin-right: -5px;">
                                <input type="text" style="height: 30px;" name="number" placeholder="搜索商品名称" autocomplete="off" class="layui-input">
                              </div>
                              <div class="layui-btn-group">
                                <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i> </button>
                              </div>
                            </div>
                      </div>
                  </form>
                </div>
                  <div class="layui-btn-group">
                    <button class="layui-btn layui-btn-sm btnadd">添加</button>
                    <button class="layui-btn layui-btn-sm btnupgoods">上架</button>
                    <button class="layui-btn layui-btn-sm btndowngoods">下架</button>
                    <button class="layui-btn layui-btn-sm btndelete">删除</button>
                  </div>
              </div>
              <!-- 全部商品 -->
              <table class="layui-table" id="qbtb" lay-filter="qbtb"></table>
            </div>
          </div>
        </div>    
    <!-- 商品修改开始 -->
    <div id="goodseditform" style="padding:10px 0 50px;display: none;">
      <form class="layui-form" action="" lay-filter="goodseditform">
      
      <div class="layui-form-item">
        <label class="layui-form-label">商品名称*</label>
        <div class="layui-input-block">
          <input type="text" name="gozname" lay-verify="required" autocomplete="off" placeholder="请输入商品名称" class="layui-input">
        </div>
      </div>
          
        
      <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">编码</label>
            <div class="layui-input-inline">
                <input type="text" name="goznumber" placeholder="请输入商品编码" class="layui-input">
            </div>
          </div>
        </div>
        
        <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">规格</label>
            <div class="layui-input-inline">
                <input type="text" name="gozspecification" placeholder="请输入商品规格" class="layui-input">
            </div>
          </div>
        </div>
        
        <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">助记码</label>
            <div class="layui-input-inline">
                <input type="text" name="gozmnemoniccode" placeholder="请输入助记码" class="layui-input">
            </div>
          </div>
        </div>
        
        <div class="layui-inline">
          <div class="layui-form-item">
            <label class="layui-form-label">排序号</label>
            <div class="layui-input-inline">
              <input type="number" name="gozsortnumber" placeholder="请输入排序号" class="layui-input">
            </div>
          </div>
        </div>
        
        <div class="layui-inline">
        <div class="layui-form-item">
          <label class="layui-form-label">标签</label>
          <div class="layui-input-inline">
            <input type="text" name="gozlabel" placeholder="请输入标签" class="layui-input">
          </div>
        </div>
        </div>
        <hr>

        <div class="layui-input-inline">
        <div class="layui-form-item">
          <label class="layui-form-label">基本单位*</label>
            <div class="layui-input-inline">
              <input type="text" name="gozunitname" lay-verify="required" placeholder="请选择基本单位" class="layui-input gozbasunit">
              <input type="text" name="gozbasunit" placeholder="请选择基本单位" class="gozbasunit-uid" style="display:none">
            </div>
            <div class="layui-inline">
                <button class="layui-btn layui-btn-primary gozbasunit">选择</button>
            </div>
        </div>
        </div>

        <div class="layui-input-inline">
        <div class="layui-form-item">
          <label class="layui-form-label">辅助单位</label>
            <div class="layui-input-inline">
              <input type="text" placeholder="请选择辅助单位" class="layui-input gozauxunit">
              <input type="text" name="gozauxunit" class="gozauxunit-uid" style="display:none">
            </div>
            <div class="layui-inline">
                <button type="reset" class="layui-btn layui-btn-primary gozauxunit">选择</button>
            </div>
        </div>
        </div>

        <div class="layui-input-inline">
        <div class="layui-form-item">
          <label class="layui-form-label">常用单位</label>
            <div class="layui-input-inline">
              <input type="text" placeholder="请选择常用单位" class="layui-input gozfrequentlyusedunit">
              <input type="text" name="gozfrequentlyusedunit"class="gozfrequentlyusedunit-uid" style="display:none">
            </div>
            <div class="layui-inline">
                <button type="reset" class="layui-btn layui-btn-primary gozfrequentlyusedunit">选择</button>
            </div>
        </div>
        </div>
        <hr>

        <div class="layui-input-inline">
        <div class="layui-form-item">
          <label class="layui-form-label">类型</label>
            <div class="layui-input-inline">
              <input type="text" placeholder="请选择类型" class="layui-input gozclas">
              <input type="text" name="gozclas" style="display:none" class="gozclas-uid">
            </div>
            <div class="layui-inline">
                <button type="reset" class="layui-btn layui-btn-primary gozclas">选择</button>
            </div>
        </div>
        </div>
        
        <div class="layui-input-inline">
        <div class="layui-form-item">
          <label class="layui-form-label">起订量单位</label>
            <div class="layui-input-inline">
              <input type="text" placeholder="请输入最小起订量" class="layui-input gozminorderunit">
              <input type="text" name="gozminorderunit"  style="display:none" class="gozminorderunit-uid">
            </div>
            <div class="layui-inline">
                <button type="reset" class="layui-btn layui-btn-primary gozminorderunit">选择</button>
            </div>
        </div>
        </div>

        <div class="layui-input-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">品牌</label>
              <div class="layui-input-inline">
                <input type="text" name="gozbrandname" placeholder="请选择品牌" class="layui-input gozbrand">
                <input type="text" name="gozbrand" style="display:none" class="gozbrand-uid">
              </div>
              <div class="layui-inline">
                  <button type="reset" class="layui-btn layui-btn-primary gozbrand">选择</button>
              </div>
        </div>
        </div>
        <hr>

        <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">单位条码</label>
            <div class="layui-input-inline">
                <input type="text" name="gozbasunitbarcode" placeholder="请输入条形码" class="layui-input">
            </div>
          </div>
        </div>
        
        <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">批发价格*</label>
            <div class="layui-input-inline">
                <input type="number" lay-verify="required" name="gozwholesaleprice" placeholder="请输入批发价" class="layui-input">
            </div>
          </div>
        </div>
        
        <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">零售价格</label>
            <div class="layui-input-inline">
                <input type="number" name="gozretailprice" placeholder="请输入零售价" class="layui-input">
            </div>
          </div>
        </div>
        
        <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">标箱系数</label>
            <div class="layui-input-inline">
                <input type="number" name="gozboxcoefficient" class="layui-input">
            </div>
          </div>
        </div>

        <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">保质期</label>
            <div class="layui-input-inline">
                <input type="number" name="gozqualityguaranteeday" placeholder="请输入保质期(天)" class="layui-input">
            </div>
          </div>
        </div>
        
        <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">销项税率</label>
            <div class="layui-input-inline">
                <input type="number" name="goztaxrate" value="16" placeholder="请输入税率" class="layui-input">
            </div>
          </div>
        </div>
         
        <div class="layui-inline">
          <div class="layui-form-item">
              <label class="layui-form-label">商城起订量</label>
              <div class="layui-input-inline">
                  <input type="number" name="gozminordernum" placeholder="请输入商城起订量" class="layui-input">
              </div>
            </div>
          </div>
          
          <div class="layui-inline">
          <div class="layui-form-item">
              <label class="layui-form-label">重量</label>
              <div class="layui-input-inline">
                  <input type="number" name="gozweight" placeholder="请输入净重" class="layui-input">
              </div>
            </div>
          </div>

          <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">商城上架</label>
                <div class="layui-input-inline">
                    <input type="checkbox" value="1" name="gozonshelf" lay-skin="switch">
                </div>
              </div>
            </div>

          <div class="layui-form-item">
              <label class="layui-form-label">商品图片</label>
                <input type="text" name="gozpictures" class="layui-hide gozpictures">
                <div class="layui-input-block">
                    <button type="button" class="layui-btn layui-btn-normal" id="uploadfile"><i class="layui-icon layui-icon-upload"></i></button>
                </div>
                <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                    预览图：
                    <div class="layui-upload-list picview" id="picview"></div>
                 </blockquote>
            </div>

          <div class="layui-form-item">
              <label class="layui-form-label"></label>
              <button type="reset" class="layui-btn layui-btn-primary reset-attapproval">取消</button>
              <button type="reset" id="sendimg" class="layui-btn pullgoods" lay-submit lay-filter="pullgoods">
                  <i class="layui-icon layui-anim layui-anim-rotate layui-anim-loop"></i> 确认修改</button>
          </div>

        </form>  
    </div>
    <!-- 商品修改结束 -->

    <!-- 基本单位开始 -->
  <div  id="jbdw" style="display: none;">
    <button  class="layui-btn layui-btn-sm empenter" style="margin-left:20px"><i class="layui-icon">&#xe605;</i>选择</button>
    <div class="layui-btn-group" style="position: relative;left: 140px;">
        <button  class="layui-btn layui-btn-primary layui-btn-sm goodsadd" style="margin-left:20px"><i class="layui-icon">&#xe654;</i>新增</button>
      <button class="layui-btn layui-btn-primary layui-btn-sm goodsedit"><i class="layui-icon">&#xe642;</i>修改</button>
      <button class="layui-btn layui-btn-primary layui-btn-sm goodsdelete"><i class="layui-icon">&#xe640;</i>删除</button>
      <button class="layui-btn layui-btn-primary layui-btn-sm empcancel"><i class="layui-icon">&#xe602;</i>取消</button>
    </div>
    <table class="layui-table" id="jbdwtb" style="margin-top: 0px"></table>
</div>
<!-- 基本单位结束 -->

<!-- 修改单位开始 -->
<div  id="xgdw" style="display: none;">
  <form class="layui-form" lay-filter="xgdw"></form>
</div>
<!-- 修改单位结束 -->

    <script type="text/html" id="img">
      {{# var path = layui.setter.root + layui.admin.base64decode(d.resourcepath)}}
        <a><img style="max-width: 35px;" src={{ path }}></a>
      </script>
    <script type="text/html" id="setting">
        <a class="layui-btn layui-btn-xs" lay-event="edit">修改</a>
        <a class="layui-btn layui-btn-xs" style="background-color:#FF5722" lay-event="delete">删除</a>
      </script>
      <script type="text/html" id="switchTpl">
        <input type="checkbox" name="gozonshelf" value="{{d.uid}}" lay-skin="switch"  lay-text="售|停" lay-filter="gozonshelf" {{ d.gozonshelf == 1 ? 'checked' : '' }}>
      </script>
  
    <script src="../lib/layui.js"></script>
    <!-- <script src="../js/attendance.js"></script> -->
     
    <script>
    layui.config({
    base: '../compontents/' //静态资源所在路径
  }).extend({
    admin: 'admin' //主入口模块
  }).use(['element','form','table','layer','admin','laydate','upload'], function(){
  var $ = layui.jquery
  ,element = layui.element
  ,form = layui.form
  ,setter = layui.setter
  ,admin = layui.admin
  ,layer = layui.layer
  ,table = layui.table
  ,upload = layui.upload
//   ,count = 0;
  var list = true // 列表/平铺
    ,alltb = false; //首次加载数据

  // 加载全部商品
  var splan = table.render({
      elem: '#qbtb',
      url: setter.layuiqueryapi,
      method:'post',
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'eos_goods',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'eos_goods',
            api: 'read',
            columns:['*', 'gozbasunit$$eos_goodsunit.gozunitname AS gozunitname','gozbrand$$eos_goodsbrand.gozbrandname AS gozbrandname','gozpictures$$bas_resource.resourcepath AS resourcepath'],
            association: {  	
              gozbasunit: {},
              gozbrand:{},
              gozpictures:{}
            },
            order: [ 
             {
              column: "uid",
              order: "DESC", //可选（默认为ASC）
             }
            ],
            // condition:{"simple":{"item1":{"column":"approver","cop":"=","value":admin.iam()}}}
          }])
        },
      cols: [[
          {type:'checkbox'}
          ,{field:'resourcepath', title: '商品',templet:'#img'}
          ,{field:'gozname', title: '名称'}
          ,{field:'gozbrandname', title: '品牌', sort: true}
          ,{field:'gozunitname', title: '单位'}
          ,{field:'gozonshelf', title: '是否上架',templet:'#switchTpl'}
          ,{field:'', title: '操作',toolbar: '#setting'}
        ]],
      page: true,
      done: function(res, curr, count){
        sPtb = true;
      }
      });
  // 删除商品 修改商品
  table.on('tool(qbtb)', function(obj){
    var deleteImg=[];
    if(obj.event === 'delete'){
      layer.confirm('真的删除么', function(index){
          admin.req({
          url: setter.standardapi //实际使用请改成服务端真实接口
          ,data: {
            model:'eos_goods',
            api:'delete',
            jsonparam: JSON.stringify({
              condition: {
                simple: {
                  item1: {
                    column: 'uid',
                    cop: '=',
                    value: obj.data.uid
                  }
                }
              }
            })
          }  
          ,success: function(res){
            if(res.errorCode === 0){
              obj.del();
            }
          }
          ,error: function(res){
            layer.msg('删除失败', {
              offset: '15px'
              ,icon: 5
              ,time: 1000
            });
          }
        });
        layer.close(index);
        });
    //修改商品
    }else if(obj.event === 'edit'){
      console.log('编辑 ',obj.data);
      var sclayer = layer.open({
      type: 1,
      title:'编辑商品',
      closeBtn: 1, //不显示关闭按钮
      anim: 2,
      area: ['500px', '480px'],
      shadeClose: false, //开启遮罩关闭
      offset: '20px',
      // maxmin:1,
      content: $('#goodseditform'),
      success: function(layero, index){
      }
    });
    layer.full(sclayer);
    $('.reset-attapproval').off('click').on('click',function(){
      layer.close(sclayer);
    })
    //表单初始赋值
    form.val("goodseditform", {
      gozbasunit: obj.data.gozbasunit,
      gozbasunitbarcode: obj.data.gozbasunitbarcode,
      gozbrand: obj.data.gozbrand,
      gozbrandname: obj.data.gozbrandname,
      gozclas: obj.data.gozclas,
      gozfrequentlyusedunit: obj.data.gozfrequentlyusedunit,
      gozlabel: obj.data.gozlabel,
      gozminordernum: obj.data.gozminordernum,
      gozmnemoniccode: obj.data.gozmnemoniccode,
      gozname: obj.data.gozname,
      goznumber: obj.data.goznumber,
      gozpictures: obj.data.gozpictures,
      gozqualityguaranteeday: obj.data.gozqualityguaranteeday,
      gozretailprice: obj.data.gozretailprice,
      gozsortnumber: obj.data.gozsortnumber,
      gozspecification: obj.data.gozspecification,
      goztaxrate: obj.data.goztaxrate,
      gozunitname: obj.data.gozunitname,
      gozwholesaleprice: obj.data.gozwholesaleprice,
    });
    //展示图片
    admin.req({
        url: setter.standardapi
        ,data: {model:'bas_resource',api:'read',jsonparam: JSON.stringify({
          condition: {
                simple: {
                  item1: {
                    column: 'resourcegroupnumber',
                    cop: '=',
                    value: obj.data.gozpictures
                  }
                }
              }
        })}      
          ,success: function(res){
            if(res.errorCode === 0){
              // 预读本地文件示例，不支持ie8
              for (const key in res.entity) {
                $('#picview').append('<a class="img-' + res.entity[key].uid +'"><i class="layui-icon layui-icon-close-fill" uid-data="'+res.entity[key].uid+'"></i> <img src="'+ setter.root + layui.admin.base64decode(res.entity[key].resourcepath) +'" class="layui-upload-img"></a>');
              }
              $('#picview>a>i').off('click').on('click',function(e){
                var uid = $(this).attr("uid-data");
                deleteImg.push(uid);
                $(".img-" + uid + "").remove(); 
              })
            }else{
              layer.msg('获取资源分组失败', {offset: '15px',icon: 5,time: 1000});
            }
          }
          ,error: function(res){layer.msg('获取资源分组失败', {offset: '15px',icon: 5,time: 1000});}
        });
      

    //多图片上传
  upload.render({
    elem: '#uploadfile'
    ,url: setter.root + '/resource/upload.api'
    ,multiple: true
    ,number:10
    ,auto: false
    ,bindAction: '#sendimg'
    ,size:2048
    ,data:{
      resourcegroupnumber: obj.data.gozpictures
    }
    ,choose: function(obj){
      //预读本地文件示例，不支持ie8
      obj.preview(function(index, files, result){
        // $('#picview').append('<img src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
        $('#picview').append('<a class="img-' + index +'"><i class="layui-icon layui-icon-close-fill" uid-data="'+index+'"></i> <img src="'+ result +'" class="layui-upload-img"></a>');
        $('#picview>a>i').off('click').on('click',function(e){
          delete files[index];      
          var uid = $(this).attr("uid-data");
          $(".img-" + uid + "").remove(); 
          })
      });
    }
    ,done: function(res){
      //上传完毕
    }
  });

   //商品修改提交form
form.on('submit(pullgoods)', function(data){
  $('.pullgoods').addClass('layui-btn-disabled').children("i.layui-icon").addClass('layui-icon-loading');
  for (const field in obj.data) {
    for (const key in data.field) {
      if (key === 'file') {
        delete data.field[key]
      }
      if (data.field[key] === '') {
        delete data.field[key]
      }
      if(data.field[key] === obj.data[field]){
        delete data.field[key]
      }
    }
  }
  console.log('data ',data.field, deleteImg);
  var dataFormat=[];
    for (let i = 0; i < deleteImg.length; i++) {
      var field ={
        model:'bas_resource',
        api:'delete',
        // entity:gozonshelf, 
        condition: {
          simple: {
            item1: {
              column: 'uid',
              cop: '=',
              value: deleteImg[i]
            }
          }
        }
      }
      dataFormat.push(field);
    }
  // 删除图片
  admin.req({
        url: setter.batchapi
        ,data: {jsonparam: JSON.stringify(dataFormat)}  
        ,success: function(res){
          if(res.errorCode === 0){
          }else{
            layer.msg('商品图片删除失败', {offset: '15px',icon: 5,time: 1000});
          }
        }
        ,error: function(res){layer.msg('商品图片删除失败' , {offset: '15px',icon: 5,time: 1000});}
    });
    // 提交商品修改
  admin.req({
        url: setter.standardapi
        ,data: {model:'eos_goods',api:'update',jsonparam: JSON.stringify(
          {
              entity:data.field, 
              condition: {
                simple: {
                  item1: {
                    column: 'uid',
                    cop: '=',
                    value: obj.data.uid
                  }
                }
              }
            }
        )}      
          ,success: function(res){
            if(res.errorCode === 0){
              layer.close(sclayer);
              $('#picview').empty();
              table.reload('qbtb');
            }else{
              layer.msg('修改失败', {offset: '15px',icon: 5,time: 1000});
            }
          }
          ,error: function(res){layer.msg('修改失败', {offset: '15px',icon: 5,time: 1000});}
        });
  return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
});

    }
  });
// 商品修改结束
  

 //监听上架下架
 form.on('switch(gozonshelf)', function(data){
   admin.req({
        url: setter.standardapi
        ,data: {
            model : 'eos_goods',
            api : 'update',
            jsonparam: JSON.stringify({
              entity:{ gozonshelf:data.elem.checked?1:0 }, 
              condition: {
                simple: {
                  item1: {
                    column: 'uid',
                    cop: '=',
                    value: data.value
                  }
                }
              }
            })
            }  
          ,success: function(res){
            if(res.errorCode === 0){
              
            }else{
              layer.msg('修改失败', {offset: '15px',icon: 5,time: 1000});
            }
          }
          ,error: function(res){layer.msg('修改失败', {offset: '15px',icon: 5,time: 1000});}
        });
  });

  //批量商品上架
  $('.btnupgoods').on('click',function(e){
    var gozonshelf = {gozonshelf:1};
    batchModData(gozonshelf,'update','商品上架失败');
    
  });
  //批量商品下架
  $('.btndowngoods').on('click',function(e){
    var gozonshelf = {gozonshelf:0};
    batchModData(gozonshelf,'update','商品下架失败');
  });
  //批量商品删除
  $('.btndelete').on('click',function(e){
    batchModData('','delete','商品删除失败');
  });
/*
@gozonshelf 商品上架下架标志 1上架 0下架
@action update或者delete
@tips 提示文字
*/
  function batchModData(gozonshelf,action,tips){
    var checkStatus = table.checkStatus('qbtb')
    ,data = checkStatus.data;
    var dataFormat=[];
    for (let i = 0; i < data.length; i++) {
      for (let key in data[i]) {
        if (key === 'uid' ) {
          var field ={
            model:'eos_goods',
            api:action,
            entity:gozonshelf, 
            condition: {
              simple: {
                item1: {
                  column: 'uid',
                  cop: '=',
                  value: ''
                }
              }
            }
          }
          field.condition.simple.item1.value = data[i][key];
          dataFormat.push(field);
        }
      }
    }
    admin.req({
        url: setter.batchapi
        ,data: {jsonparam: JSON.stringify(dataFormat)}  
        ,success: function(res){
          if(res.errorCode === 0){
            table.reload('qbtb');     
          }else{
            layer.msg(tips, {offset: '15px',icon: 5,time: 1000});
          }
        }
        ,error: function(res){layer.msg(tips, {offset: '15px',icon: 5,time: 1000});}
    });
  }
  
  
  //添加商品
  $('.btnadd').on('click',function(e){
    //新增一个Tab项
    parent.layui.element.tabAdd('kt_toptab', {
        title: '添加商品' 
        ,content: '<iframe  tab-id=035 id=iframe035 frameborder=0 src=pages/goodsadd.html scrolling=yes class=kt-iframe ></iframe>'
        ,id: 035
    });
    //切换到指定Tab项
    parent.layui.element.tabChange('kt_toptab', 035);
  })
 
  // 基本单位
  $('.gozbasunit').on('click',function(e){
    var cols= [[
            {type:'radio'}
            ,{field:'gozunitname', title: '单位名称'}
            ,{field:'gozunitsortnumber', title: '单位排序号', sort: true}
            ,{field:'gozunitconversionrate', title: '换算率'}
            ]];
    getBasicData('商品基本单位','eos_goodsunit',cols,'gozbasunit');
    e.preventDefault();
  });
  // 辅助单位
  $('.gozauxunit').on('click',function(e){
    var cols= [[
            {type:'radio'}
            ,{field:'gozauxunitbarcode', title: '条形码'}
            ,{field:'gozauxunit', title: '辅助单位', sort: true}
            ,{field:'gozuid', title: '商品'}
            ]];
    getBasicData('商品辅助单位','eos_goodsauxiliaryunit',cols,'gozauxunit');
    e.preventDefault();
  });
  // 常用单位
  $('.gozfrequentlyusedunit').on('click',function(e){
    var cols= [[
            {type:'radio'}
            ,{field:'gozunitname', title: '单位名称'}
            ,{field:'gozunitsortnumber', title: '单位排序号', sort: true}
            ,{field:'gozunitconversionrate', title: '换算率'}
            ]];
    getBasicData('商品常用单位','eos_goodsunit',cols,'gozfrequentlyusedunit');
    e.preventDefault();
  });
  // 商品类型
  $('.gozclas').on('click',function(e){
    var cols= [[
            {type:'radio'}
            ,{field:'gozclasname', title: '类型名称'}
            ,{field:'gozclassortnumber', title: '类型排序号', sort: true}
            ,{field:'gozclasparent', title: '上级类型'}
            ]];
    getBasicData('商品类型','eos_goodsclass',cols,'gozclas');
    e.preventDefault();
  });
  // 商品起订量单位
  $('.gozminorderunit').on('click',function(e){
    var cols= [[
            {type:'radio'}
            ,{field:'gozunitname', title: '单位名称'}
            ,{field:'gozunitsortnumber', title: '单位排序号', sort: true}
            ,{field:'gozunitconversionrate', title: '换算率'}
            ]];
    getBasicData('商品基本单位','eos_goodsunit',cols,'gozminorderunit');
    e.preventDefault();
  });
  // 商品品牌
  $('.gozbrand').on('click',function(e){
    var cols= [[
            {type:'radio',}
            ,{field:'gozbrandname', title: '品牌名称'}
            ,{field:'gozbrandsortnumber', title: '品牌排序号', sort: true}
            ,{field:'gozbranddept', title: '所属部门'}
            ]];
    getBasicData('商品品牌','eos_goodsbrand',cols,'gozbrand');
    e.preventDefault();
  });
 
 

  /* 渲染对象数据表格
  title: 弹出表格选择框标题
  model:弹出表格框要获取的数据model名称
  cols: 弹出表格列名称
  name: 备选form字段name值
*/
  function getBasicData(title,model,cols,name){
  var emplayer = layer.open({
      type: 1,
      title:title,
      // skin: 'layui-layer-demo', //样式类名
      closeBtn: 1, //不显示关闭按钮
      anim: 2,
      area: ['500px', '480px'],
      shadeClose: true, //开启遮罩关闭
      offset: '20px',
      // maxmin:1,
      content: $('#jbdw')
    });
    var empTable = table.render({
      elem: '#jbdwtb',
      url: setter.layuiqueryapi,
      method:'post',
      // height:357,
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: model,
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: model,
            api: 'read',
            // columns:['*', 'dept$$org_department.deptname AS deptname'],
	        }])},
          cols: cols,
          page: true,
          done: function(res, curr, count){
          }
          });
    // 选择数据
    $('.empenter').off('click').on('click',function(){
      var checkStatus = table.checkStatus('jbdwtb');
      if(checkStatus.data.length === 0){
        layer.msg('没有选择任何数据');
        return;
      }
      var data = checkStatus.data[0];
      $('.' + name + '-uid').val(data.uid);
      for (const key in data) {
        if (key.indexOf('name') !== -1) {
          $('.' + name).val(data[key]);
        }
      }
      layer.close(emplayer);
    })
    // 取消选择
    $('.empcancel').off('click').on('click',function(){
      layer.close(emplayer);
    });
    // 新增数据
    $('.goodsadd').off('click').on('click',function(){
      createFormItem(cols,"新增",null,model,empTable);
    });
    // 修改数据
    $('.goodsedit').off('click').on('click',function(){
      var checkStatus = table.checkStatus('jbdwtb');
      if(checkStatus.data.length === 0){
        layer.msg('没有选择任何数据');
        return;
      }
      var data = checkStatus.data
      createFormItem(cols,"修改",data[0],model,empTable);
    });
    // 删除数据
    $('.goodsdelete').off('click').on('click',function(){
      var checkStatus = table.checkStatus('jbdwtb');
      if(checkStatus.data.length === 0){
        layer.msg('没有选择任何数据');
        return;
      }
      var data = checkStatus.data[0];
      admin.req({
        url: setter.standardapi
        ,data: {model:model,api:'delete',jsonparam: JSON.stringify({
              condition: {
                simple: {
                  item1: {
                    column: 'uid',
                    cop: '=',
                    value: data.uid
                  }
                }
              }
            })}      
          ,success: function(res){
            if(res.errorCode === 0){empTable.reload();}
            }
          ,error: function(res){layer.msg('删除失败', {offset: '15px',icon: 5,time: 1000});}
        });
    });
}
  // 通过所选对象 渲染对象表单
  function createFormItem(cols,title,data,model,empTable){
    $('#xgdw>form').empty();
      var columns = cols[0];
      var formItem = ""
      for (let i = 1; i < columns.length; i++) {
        formItem += "<div class=layui-form-item><label class=layui-form-label>"
        + columns[i].title + "</label><div class=layui-input-inline><input type=text name="
        +columns[i].field + " autocomplete=off placeholder=请输入"
        +columns[i].title + " class=layui-input></div></div>"
      }
      if( title === '修改'){
        formItem += "<div class=layui-form-item><input name=uid style='display:none'></div>"
      }
      formItem += "<div class=layui-form-item><label class=layui-form-label></label><button model="
      + model +" lay-submit lay-filter='btnxgdw' class=layui-btn>确定</button><button class='layui-btn layui-btn-primary editcancel'>取消</button></div>"
      $('#xgdw>form').prepend(formItem);
      var editlayer = layer.open({
      type: 1,
      title: title,
      closeBtn: 1, //不显示关闭按钮
      anim: 2,
      area: ['400px', '370px'],
      offset: '40px',
      content: $('#xgdw')
      });
      if( title === '修改'){
        form.val("xgdw", data);
      }
      $('.editcancel').off('click').on('click',function(e){
        layer.close(editlayer);
        e.preventDefault();
      })
      console.log(1);
  // 内部提交表单 增删改查
  form.on('submit(btnxgdw)', function(data){
  var model = $(data.elem).attr('model');
  var api = '';
  var data = data.field
  for (const key in data) {
    if(data[key] === ''){
      delete data[key];
    }
    if (key === 'uid') {
      api = 'update';
    }else{
      api = 'create';
    }
  }
    if (api === 'update') {
      admin.req({
        url: setter.standardapi
        ,data: {model:model,api:api,jsonparam: JSON.stringify({
          entity:data,
          condition: {
            simple: {
              item1: {
                column: 'uid',
                cop: '=',
                value: data.uid
              }
            }
          }
        })}      
          ,success: function(res){
            if(res.errorCode === 0){empTable.reload();}else{layer.msg('修改失败', {offset: '15px',icon: 5,time: 1000});}
            }
          ,error: function(res){layer.msg('修改失败', {offset: '15px',icon: 5,time: 1000});}
        });
    }else{
      admin.req({
        url: setter.standardapi
        ,data: {model:model,api:api,jsonparam: JSON.stringify(data)}      
          ,success: function(res){
            if(res.errorCode === 0){
              empTable.reload();
            }else{
              layer.msg('新增失败', {offset: '15px',icon: 5,time: 1000});
            }
          }
          ,error: function(res){layer.msg('新增失败', {offset: '15px',icon: 5,time: 1000});}
        });
    }
    layer.close(editlayer);
  return false;
  });
  }
   
});
    </script>  
    </body>
</html>