<!DOCTYPE html>
<!-- 订货清单 页面 -->
<html>
    <head>
        <meta charset="UTF-8">
        <title>订货清单-快销宝-深圳市沟通科技有限公司</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8" />
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="../lib/css/layui.css">
        <link rel="stylesheet" href="../css/shelves.min.css">
        <style>
          /* 订货清单 */
  .phqdpanl{
    display: none;
    text-align: center;
    color: #393D49;
    margin: 0 60px;
    font-size: 15px;
  }
  .phqdpanl h2{
    margin-bottom: 30px;
  }
  .phqdpanl h4,.ph-content p,.ph-content div{
    display: inline;
  }
  .ph-content div{
    margin: 20px 20px;
    line-height: 40px;
  }
  .ph-content img{
    width: 30px;
    height: 30px;
    margin-right: 10px;
    border-radius: 50%;
  }
  .ph-content a{
    cursor: pointer;
  }
  </style>
    </head>
    <body style="overflow-y: scroll;">
        <div class="layui-tab layui-tab-brief" lay-filter="task" style="margin: 0px;">
          <ul class="layui-tab-title">
            <li class="layui-this">订货单</li>
            <li>发货单</li>
            <li>补货单</li>
            <li>收货单</li>
          </ul>
          <div class="layui-tab-content" style="padding: 0px;">
            <!-- 订货单 -->
            <div class="layui-tab-item layui-show">
                <div class="layui-row" style="position: absolute;top: 5px;right: 5px;">
                  <div class="layui-inline">
                    <form class="layui-form" action="">
                      <div class="layui-input-inline select-height">
                        <div class="layui-input-inline">
                          <div class="layui-input-inline" style="margin-right: -5px;">
                            <input type="text" style="height: 30px;" name="number" placeholder="搜索订货单" autocomplete="off" class="layui-input">
                          </div>
                          <div class="layui-btn-group">
                            <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i> </button>
                          </div>
                        </div>
                      </div>
                  </form>
                </div>
              </div>
              <!-- 订货单表格 -->
              <table class="layui-table" id="dhdtb" lay-filter="dhdtb"></table>
            </div>
            <!-- 发货单 -->
            <div class="layui-tab-item">
                <div class="layui-row" style="position: absolute;top: 5px;right: 5px;">
                  <div class="layui-inline">
                    <form class="layui-form" action="">
                      <div class="layui-input-inline select-height">
                        <div class="layui-input-inline">
                          <div class="layui-input-inline" style="margin-right: -5px;">
                            <input type="text" style="height: 30px;" name="number" placeholder="搜索发货单" autocomplete="off" class="layui-input">
                          </div>
                          <div class="layui-btn-group">
                            <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i> </button>
                          </div>
                        </div>
                      </div>
                  </form>
                </div>
              </div>
              <!-- 发货单表格 -->
              <table class="layui-table" id="fhdtb" lay-filter="fhdtb"></table>
            </div>
            <!-- 补货单 -->
            <div class="layui-tab-item">
                <div class="layui-row" style="position: absolute;top: 5px;right: 5px;">
                  <div class="layui-inline">
                    <form class="layui-form" action="">
                      <div class="layui-input-inline select-height">
                        <div class="layui-input-inline">
                          <div class="layui-input-inline" style="margin-right: -5px;">
                            <input type="text" style="height: 30px;" name="number" placeholder="搜索补货单" autocomplete="off" class="layui-input">
                          </div>
                          <div class="layui-btn-group">
                            <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i> </button>
                          </div>
                        </div>
                      </div>
                  </form>
                </div>
              </div>
              <!-- 补货单表格 -->
              <table class="layui-table" id="bhdtb" lay-filter="bhdtb"></table>
            </div>
            <!-- 收货单 -->
            <div class="layui-tab-item">
                <div class="layui-row" style="position: absolute;top: 5px;right: 5px;">
                  <div class="layui-inline">
                    <form class="layui-form" action="">
                      <div class="layui-input-inline select-height">
                        <div class="layui-input-inline">
                          <div class="layui-input-inline" style="margin-right: -5px;">
                            <input type="text" style="height: 30px;" name="number" placeholder="搜索收货单" autocomplete="off" class="layui-input">
                          </div>
                          <div class="layui-btn-group">
                            <button class="layui-btn layui-btn-primary layui-btn-sm "><i class="layui-icon">&#xe615;</i> </button>
                          </div>
                        </div>
                      </div>
                  </form>
                </div>
              </div>
              <!-- 收单表格 -->
              <table class="layui-table" id="shdtb" lay-filter="shdtb"></table>
            </div>
    <!-- 订货清单开始 -->
    <div id="phqdpanl" class="phqdpanl">
        <!-- <h2>订货清单</h2> -->
        <div class="ph-content">
            <!-- <div><p>客户 : </p><p class="custmname"></p></div>
            <div><p>客户地址 : </p><p class="custmaddress"></p></div>
            <div><p>收货人 : </p><p class="custmcontact"></p></div>
            <div><p>订货说明 : </p><p class="odcomment"></p></div>
            <div><p>订货时间 : </p><p class="oddatetime"></p></div>
            <div><p>订货人 : </p><p class="empname"></p></div> -->
            <!-- <div><p>订货照片 : </p><a class="oddpictures" title="无照片"><img src="../images/no_photos.jpg"></a></div> -->
        </div>
        <table class="layui-table" id="phtb" lay-filter="phtb"></table>
      </div>
    <!-- 订货清单结束 -->
    <script type="text/html" id="setting">
      <a class="layui-btn layui-btn-xs" lay-event="view" >订货清单</a>
    </script>
    <script type="text/html" id="fhsetting">
      <a class="layui-btn layui-btn-xs" lay-event="view" >发货清单</a>
    </script>
    <script type="text/html" id="bhsetting">
      <a class="layui-btn layui-btn-xs" lay-event="view" >补货清单</a>
    </script>
    <script type="text/html" id="shsetting">
      <a class="layui-btn layui-btn-xs" lay-event="view" >收货清单</a>
    </script>
    <script type="text/html" id="time">
        {{# var t = layui.admin.formatDateTime(d.oddatetime); }}
        <span>{{ t }}</span>
      </script>
    <script type="text/html" id="fhtime">
        {{# var t = layui.admin.formatDateTime(d.fahdatetime); }}
        <span>{{ t }}</span>
      </script>
    <script type="text/html" id="bhtime">
        {{# var t = layui.admin.formatDateTime(d.buhdatetime); }}
        <span>{{ t }}</span>
      </script>
    <script type="text/html" id="shtime">
        {{# var t = layui.admin.formatDateTime(d.shouhdatetime); }}
        <span>{{ t }}</span>
      </script>
      
      <script type="text/html" id="state">
        {{#  if(d.odstate === 0){ }}
          <span style="color: #FFB800;">待审批</span>
        {{#  } else if(d.odstate === 1){ }}
          <span style="color: #5FB878;">已审批</span>
        {{#  }else if (d.odstate === 2){ }}
          <span style="color: #5FB878;">已发货</span>
        {{#  }else if(d.odstate === 3){ }}
          <span style="color: #5FB878;">已收货</span>
        {{#  }else if (d.odstate === 4){ }}
          <span style="color: #5FB878;">已完结</span>
        {{#  } }}
      </script> 
      
      <script type="text/html" id="fhstate">
        {{#  if(d.fahstate === 0){ }}
          <span style="color: #FFB800;">待审批</span>
        {{#  } else if(d.fahstate === 1){ }}
          <span style="color: #5FB878;">已审批</span>
        {{#  }else if (d.fahstate === 2){ }}
          <span style="color: #5FB878;">已收货</span>
        {{#  } }}
      </script> 
      
      <script type="text/html" id="bhstate">
        {{#  if(d.buhstate === 0){ }}
          <span style="color: #FFB800;">待审批</span>
        {{#  } else if(d.buhstate === 1){ }}
          <span style="color: #5FB878;">已审批</span>
        {{#  } }}
      </script> 
    
      <script type="text/html" id="play">
        {{#  if(d.odpayment === 0){ }}
          <span style="color: #FFB800;">未付款</span>
        {{#  } else if(d.odpayment === 1){ }}
          <span style="color: #5FB878;">已付款</span>
        {{#  } }}
      </script> 
    
      <script type="text/html" id="bhflag">
        {{#  if(d.odbuhflg === 0){ }}
          <span>无</span>
        {{#  } else if(d.odbuhflg === 1){ }}
          <span style="color: #5FB878;">需补货</span>
        {{#  } }}
      </script> 

    <script src="../lib/layui.js"></script>
    <!-- <script src="../js/attendance.js"></script> -->
     
    <script>
    layui.config({
    base: '../compontents/' //静态资源所在路径
  }).extend({
    admin: 'admin' //主入口模块
  }).use(['element','form','table','layer','admin'], function(){
  var $ = layui.jquery
  ,element = layui.element
  ,form = layui.form
  ,setter = layui.setter
  ,admin = layui.admin
  ,layer = layui.layer
  ,table = layui.table
  // 发货单 补货单 收货单 加载标记
  ,fhd = true
  ,bhd = true
  ,shd = true;

  // 加载订货单
  var splan = table.render({
      elem: '#dhdtb',
      url: setter.layuiqueryapi,
      method:'post',
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'eos_order',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'eos_order',
            api: 'read',
            columns:['*', 'odoriginator$$bas_user.nickname AS nickname',
            'odapprover$$org_employee.empname AS proverempname',
            'odcustomer$$crm_customer.custmname AS custmname',
            'odpictures$$bas_resource.resourcegroupnumber AS resourcegroupnumber'],
            association: {  	
              odoriginator: {},
              odcustomer:{},
              odapprover:{},
              odpictures:{},
            },
            order: [ 
             {
              column: "uid",
              order: "DESC", //可选（默认为ASC）
             }
            ],
          }])
        },
      cols: [[
          {type:'checkbox'}
          ,{field:'odnumber', title: '订单号'}
          ,{field:'custmname', title: '客户'}
          ,{field:'odamount', title: '订单金额'}
          ,{field:'odstate', title: '状态',templet:'#state'}
          ,{field:'odpayment', title: '支付状态',templet:'#play'}
          ,{field:'odbuhflg', title: '补货',templet:'#bhflag'}
          ,{field:'odreceipt', title: '收款金额'}
          ,{field:'proverempname', title: '审批人'}
          ,{field:'oddatetime', title: '订货时间', sort: true,templet:'#time'}
          ,{field:'nickname', title: '订货人'}
          ,{field:'', title: '操作',toolbar: '#setting'}
        ]],
      page: true,
      done: function(res, curr, count){
      }
      });

  // 切换tab页面
  element.on('tab(task)', function(data){
    // 发货单
    if(data.index === 1 && fhd){
      // 加载发货单
      table.render({
      elem: '#fhdtb',
      url: setter.layuiqueryapi,
      method:'post',
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'eos_fahuo',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'eos_fahuo',
            api: 'read',
            columns:['*', 'fahapprover$$org_employee.empname AS fahapprovername',
            'fahcustomer$$crm_customer.custmname AS custmname',
            'fahorder$$eos_order.odnumber AS odnumber',
            'fahoriginator$$bas_user.nickname AS nickname'],
            association: {  	
              fahoriginator: {},
              fahorder:{},
              fahcustomer:{},
              fahapprover:{},
            },
            order: [ 
             {
              column: "uid",
              order: "DESC", //可选（默认为ASC）
             }
            ],
          }])
        },
      cols: [[
          {type:'checkbox'}
          ,{field:'fahnumber', title: '发货单号'}
          ,{field:'custmname', title: '客户'}
          ,{field:'fahdatetime', title: '发货时间', sort: true,templet:'#fhtime'}
          ,{field:'fahamount', title: '金额'}
          ,{field:'fahcomment', title: '发货说明'}
          ,{field:'odnumber', title: '订货单'}
          ,{field:'fahstate', title: '状态',templet:'#fhstate'}
          ,{field:'fahreceiver', title: '收货人'}
          ,{field:'nickname', title: '发货人'}
          ,{field:'fahapprovername', title: '审批人'}
          ,{field:'', title: '操作',toolbar: '#fhsetting'}
        ]],
      page: true,
      done: function(res, curr, count){
      }
      });
      fhd = false;
      return;
    }
    // 补货单
    if(data.index === 2 && bhd ){
       // 加载补货单
       table.render({
      elem: '#bhdtb',
      url: setter.layuiqueryapi,
      method:'post',
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'eos_buhuo',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'eos_buhuo',
            api: 'read',
            columns:['*', 'buhapprover$$org_employee.empname AS proverempname',
            'buhcustomer$$crm_customer.custmname AS custmname',
            'buhorder$$eos_order.odnumber AS odnumber',
            'buhoriginator$$bas_user.nickname AS nickname'],
            association: {  	
              buhoriginator: {},
              buhcustomer:{},
              buhapprover:{},
              buhorder:{},
            },
            order: [ 
             {
              column: "uid",
              order: "DESC", //可选（默认为ASC）
             }
            ],
          }])
        },
      cols: [[
          {type:'checkbox'}
          ,{field:'buhdatetime', title: '补货时间', sort: true,templet:'#bhtime'}
          ,{field:'buhamount', title: '金额'}
          ,{field:'buhnumber', title: '补货单号'}
          ,{field:'buhcomment', title: '补货说明'}
          ,{field:'buhstate', title: '状态',templet:'#bhstate'}
          ,{field:'buhreceiver', title: '收货人'}
          ,{field:'nickname', title: '补货人'}
          ,{field:'custmname', title: '客户'}
          ,{field:'proverempname', title: '审批人'}
          ,{field:'odnumber', title: '原订货单'}
          ,{field:'', title: '操作',toolbar: '#bhsetting'}
        ]],
      page: true,
      done: function(res, curr, count){
      }
      });
      bhd = false;
      return;
    }
    // 收货单
    if(data.index === 3 && shd ){
       // 加载收货单
       table.render({
      elem: '#shdtb',
      url: setter.layuiqueryapi,
      method:'post',
      where: 	{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'eos_shouhuo',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'eos_shouhuo',
            api: 'read',
            columns:['*', 'shouhoriginator$$bas_user.nickname AS nickname',
            'shouhfah$$eos_fahuo.fahnumber AS fahnumber',
            'shouhbuh$$eos_buhuo.buhnumber AS buhnumber'],
            association: {  	
              shouhoriginator: {},
              shouhfah:{},
              shouhbuh:{}
            },
            order: [ 
             {
              column: "uid",
              order: "DESC", //可选（默认为ASC）
             }
            ],
          }])
        },
      cols: [[
          {type:'checkbox'}
          ,{field:'shouhdatetime', title: '收货时间', sort: true,templet:'#shtime'}
          ,{field:'shouhamount', title: '金额'}
          ,{field:'shouhnumber', title: '收货单号'}
          ,{field:'shouhcomment', title: '收货说明'}
          ,{field:'nickname', title: '收货人'}
          ,{field:'fahnumber', title: '发货单'}
          ,{field:'buhnumber', title: '补货单'}
          ,{field:'', title: '操作',toolbar: '#shsetting'}
        ]],
      page: true,
      done: function(res, curr, count){
      }
      });
      shd = false;
      return;
    }
  });

  // 查看订货清单
  table.on('tool(dhdtb)', function(obj){
    if(obj.event === 'view'){
      var data = obj.data;
      console.log(data);
      var template = "<div><h4>订单号：</h4><p>"+data.odnumber+"</p></div>" +
            "<div><h4>客户：</h4><p>"+ data.custmname+"</p></div>" +
            "<div><h4>订单状态：</h4><p>"+ data.odstate+"</p></div>" +
            "<div><h4>付款状态：</h4><p>"+ data.odpayment+"</p></div>" +
            "<div><h4>补货：</h4><p>"+ data.odbuhflg+"</p></div>" +
            "<div><h4>收款金额：</h4><p>"+ data.odreceipt+"</p></div>" +
            "<div><h4>审批人：</h4><p>"+ data.proverempname+"</p></div>" +
            "<div><h4>订货时间：</h4><p>"+ data.oddatetime+"</p></div>" +
            "<div><h4>订货人：</h4><p>"+ data.nickname+"</p></div>" +
            "<div><h4>订货照片 : </h4><a title=无照片><img src=../images/no_photos.jpg></a></div>";
      $('.ph-content').append(template);
      goodsdetils('订货清单',data,template);
    }
  });
  // 查看发货清单
  table.on('tool(fhdtb)', function(obj){
    if(obj.event === 'view'){
      
    }
  });
  // 查看补货清单
  table.on('tool(bhdtb)', function(obj){
    if(obj.event === 'view'){
      
    }
  });
  // 查看收货清单
  table.on('tool(shdtb)', function(obj){
    if(obj.event === 'view'){
      
    }
  });
  function goodsdetils(title){
    var phlayer =layer.open({
        type: 1,
        title:title,
        // skin: 'layui-layer-demo', //样式类名
        closeBtn: 1, //不显示关闭按钮
        maxmin:true,
        anim: 2,
        area: ['600px', '500px'],
        // shadeClose: false, //开启遮罩关闭
        // offset: '20px',
        content: $('#phqdpanl')
      });
      layer.full(phlayer);
      $('.layui-layer-content').on('resize',function(){}); // 监听弹出层缩放 使表格自适应。
      $(".custmname").text(obj.data.custmname);
      $(".custmaddress").text(obj.data.custmaddress);
      $(".custmcontact").text(obj.data.custmcontact);
      $(".odcomment").text(obj.data.odcomment);
      $(".oddatetime").text( admin.formatDateTime(obj.data.oddatetime));
      $(".empname").text(obj.data.empname);
      if(obj.data.resourcegroupnumber){
        $(".oddpictures").empty();
        //展示图片
    admin.req({
        url: setter.standardapi
        ,data: {model:'bas_resource',api:'read',jsonparam: JSON.stringify({
          condition: {
                simple: {
                  item1: {
                    column: 'resourcegroupnumber',
                    cop: '=',
                    value: obj.data.resourcegroupnumber
                  }
                }
              }
        })}      
          ,success: function(res){
            if(res.errorCode === 0){
              var data = [];
              for (let i = 0; i < res.entity.length; i++) {
                  var item={};
                  res.entity[i].resourcepath = setter.root + admin.base64decode(res.entity[i].resourcepath);
                  item.alt = res.entity[i].resourcename,
                  item.pid = res.entity[i].uid, 
                  item.src = res.entity[i].resourcepath, 
                  item.thumb = res.entity[i].resourcepath
                  data.push(item);
                  $(".oddpictures").append('<img src="'+ res.entity[i].resourcepath +'" class="layui-upload-img">');
              }
              $(".oddpictures").attr('title','查看大图').off('click').on('click',function(){
                layer.photos({
                  photos: {
                    "title": "现场照片", //相册标题
                    "id": 123, //相册id
                    "start": 0, //初始显示的图片序号，默认0
                    "data":data
                  }
                  ,anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
                });
              });

            }else{
              layer.msg('获取资源分组失败', {offset: '15px',icon: 5,time: 1000});
            }
          }
          ,error: function(res){layer.msg('获取资源分组失败', {offset: '15px',icon: 5,time: 1000});}
        });
        
      }else{
        // 没有照片显示默认图片
        $(".oddpictures").empty().attr("title","无照片").append("<img src=../images/no_photos.jpg>");
      }
      // 加载订货商品
  var splan = table.render({
      elem: '#phtb',
      data:obj.data.eos_oddetaillist,
      cols: [[
          {type:'checkbox'}
          ,{field:'gozname', title: '商品'}
          ,{field:'gozunitname', title: '单位'}
          ,{field:'oddlprice', title: '单价'}
          ,{field:'oddlquantity', title: '数量'}
        ]]
      });
  }
});
    </script>  
    </body>
</html>