<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>layui</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../lib/css/layui.css"  media="all">
  <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
   <style>
     .plan-waper{
       text-align: center;
       line-height: 30px;
       margin: 10px 60px;
     }
     .plan-title{
       font-size: 20px;
       font-weight: 400;
     }
     .plan-author{
       margin: 0 10px;
     }
     .create-time{
       text-align: right;
       margin-right: 60px;
     }
     .plan-date{
       margin: 0 20px;
     }
     .plan-content{
       text-align: left;
      margin: 20px 0px;
      text-indent:30px;
     }
   </style>
</head>
<body>
    <table class="layui-table" id="sendplan" lay-filter="sendplan"> </table>
      

    <script type="text/html" id="view">
      <a class="layui-btn layui-btn-xs" lay-event="view">执行情况</i></a>
    </script> 


    <script src="../lib/layui.js"></script>

      <script>
     layui.config({
    base: '../compontents/' //静态资源所在路径
  }).extend({
    admin: 'admin' //主入口模块
  }).use(['element','form','table','layer','admin','laydate'], function(){
        var layer = layui.layer;
        var table = layui.table;
        var setter = layui.setter;
        var admin = layui.admin;
        var $ = layui.$;

        
    var plandetil = table.render({
      elem: '#sendplan',
      // height: 20%,
      url: setter.layuiqueryapi,
      method:'post',
      where:{jsonparam: JSON.stringify([{
            solve_name_conflict: false,
        		model: 'oa_plantask',
        		api: 'read',
	        	columns: ['count(uid) AS total'],
	        },{
        		model: 'oa_plantask',
            api: 'read',
            columns:["oa_plantask.*","plancreator$$org_employee.empname AS creatorname"],
            association: {  	
              plancreator:{}
            },
            order: [ 
             {
              column: "uid",
              order: "DESC", //可选（默认为ASC）
             }
            ],
            // condition:{"simple":{"item1":{"column":"plancreator","cop":"=","value":3500}}}
          }])
        },
      cols: [[
          {type:'checkbox'}
          ,{field:'plancreatetime', title: '创建时间', sort: true,templet: '#createtime'}
          ,{field:'planstartdate', title: '开始时间'}
          ,{field:'planenddate', title: '结束时间'}
          ,{field:'plantitle', title: '计划标题', sort: true}
          ,{field:'plancontent', title: '内容'}
          ,{field:'weibanli', title: '操作',toolbar: '#view'}
        ]],
      page: true,
      done: function(res, curr, count){
        sPlantb = true;
      }

      });
      
      table.on('tool(sendplan)', function(obj){
    var data = obj.data;
    if(obj.event === 'view'){
      console.log(data);
      admin.req({
          url: setter.standardapi
            ,data: {
               model: 'oa_plantask_result',
               api: 'read',
               jsonparam: JSON.stringify({
                columns:["oa_plantask_result.*","planretexector$$org_employee.empname AS empname"],
                association: { 
                  planretexector: {},
                  planretappendixlist:{}
                },
                condition:{"simple":{"item1":{"column":"plan","cop":"=","value":data.uid}}}
               })
              }      
            ,success: function(res){
              if(res.errorCode === 0){
                plandetil.reload({
                  height: 400
                }); 
              }
          }
            ,error: function(res){
              //登入成功的提示与跳转
              layer.msg('创建失败', {
                offset: '15px'
                ,icon: 5
                ,time: 1000
              });
            }
          });
    }
  });

      });
      </script>  
</body>
</html>